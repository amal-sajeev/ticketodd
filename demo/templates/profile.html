{% extends "base.html" %}
{% block title %}Profile ΓÇö PR&DW Portal{% endblock %}

{% block head %}
<!-- Allow camera access -->
<meta http-equiv="Permissions-Policy" content="camera=*">
<style>
    /* Profile-specific Glass Theme */
    .profile-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.4);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .glass-header {
        background: linear-gradient(135deg, rgba(15, 76, 129, 0.9) 0%, rgba(30, 136, 229, 0.9) 100%);
        padding: 3rem 2rem;
        color: white;
        position: relative;
        text-align: center;
    }

    .glass-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 60%);
        pointer-events: none;
    }

    .avatar-large {
        width: 100px;
        height: 100px;
        background: white;
        color: #0f4c81;
        border-radius: 50%;
        font-size: 40px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem auto;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 2;
    }

    .glass-body {
        padding: 2rem;
    }

    .profile-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #5f6368;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .form-control-glass {
        width: 100%;
        padding: 0.8rem 1rem;
        border-radius: 8px;
        border: 1px solid #e1e3e8;
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.95rem;
        color: #333;
    }

    .form-control-glass:disabled {
        background: #f1f3f4;
        color: #74777f;
        cursor: not-allowed;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1a1c1e;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: #0f4c81;
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary:hover {
        background: #0d3d66;
    }

    .btn-secondary {
        background: #f1f3f4;
        color: #333;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid #ddd;
        color: #666;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
    }

    /* Video Container Reused */
    .video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 4/3;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1rem;
        display: none;
    }

    .video-container.active {
        display: block;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
    }

    canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
    }

    @media (max-width: 768px) {
        .profile-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="profile-container">
        <div class="glass-card">
            <div class="glass-header">
                <div class="avatar-large" id="avatarLetter"></div>
                <h2 id="pName" style="margin:0;font-size:1.8rem;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,0.25), 0 0 20px rgba(255,255,255,0.15);letter-spacing:0.02em;">Loading...</h2>
                <p id="pRole" style="margin:0.5rem 0 0;text-transform:capitalize;font-size:1rem;color:rgba(255,255,255,0.88);text-shadow:0 1px 4px rgba(0,0,0,0.2);letter-spacing:0.03em;"></p>
            </div>

            <div class="glass-body">
                <div class="profile-grid">
                    <!-- Personal Info -->
                    <div>
                        <h3 class="section-title"><span class="icon" style="color:#0f4c81;">badge</span> Personal
                            Details</h3>
                        <div class="form-group" style="margin-bottom:1.5rem;">
                            <label>Username</label>
                            <input type="text" class="form-control-glass" id="pUsername" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" class="form-control-glass" id="pEmail" readonly disabled>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div>
                        <div style="background: #f8f9fa; border-radius:12px; padding:1.5rem;">
                            <h3 class="section-title" style="margin-top:0;"><span class="icon"
                                    style="color:#0f4c81;">face</span> Face ID Security</h3>

                            <div
                                style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
                                <span style="font-size:0.9rem;color:#555;">Current Status</span>
                                <span id="faceIdStatus" class="badge">Checking...</span>
                            </div>

                            <p style="font-size:0.85rem;color:#666;line-height:1.5;margin-bottom:1.5rem;">
                                Secure your account with biometric face recognition. This allows for faster login
                                without passwords.
                            </p>

                            <!-- Action Area -->
                            <div id="faceActionContainer">
                                <button id="startFaceBtn" class="btn-primary" style="width:100%;display:none;"
                                    onclick="startFaceEnrollment()">
                                    Set up Face ID
                                </button>
                                <button id="removeFaceBtn" class="btn-outline"
                                    style="width:100%;display:none;color:#d32f2f;border-color:#ffcdd2;"
                                    onclick="removeFaceId()">
                                    Remove Face ID
                                </button>
                            </div>

                            <!-- Camera Area -->
                            <div id="cameraSection" style="display:none;margin-top:1rem;">
                                <div class="video-container active" id="cameraContainer">
                                    <video id="video" autoplay muted playsinline></video>
                                    <canvas id="canvas"></canvas>
                                </div>
                                <p class="text-center text-sm mb-3" id="camStatus" style="color:#5f6368;">
                                    Initializing...</p>

                                <button class="btn-secondary" id="captureBtn" style="width:100%;margin-bottom:0.5rem;"
                                    onclick="captureFace()" disabled>
                                    Capture Face
                                </button>

                                <button class="btn-primary" id="saveBtn"
                                    style="width:100%;display:none;margin-bottom:0.5rem;" onclick="saveFace()">
                                    Save Face ID
                                </button>

                                <button class="btn-outline" style="width:100%;border:none;color:#5f6368;"
                                    onclick="cancelFaceEnrollment()">
                                    Cancel
                                </button>
                            </div>

                            <div id="profileError"
                                style="color:#d32f2f;background:#ffebee;padding:0.5rem;border-radius:6px;font-size:0.85rem;margin-top:1rem;display:none;text-align:center;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
    let stream = null;
    let faceDescriptor = null;
    let faceModelsLoaded = false;
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', loadProfile);

    async function loadProfile() {
        if (!requireAuth()) return;
        try {
            currentUser = await api('GET', '/auth/me');
            if (!currentUser) return;

            setAuth(getToken(), currentUser); // Sync local data

            document.getElementById('pName').textContent = currentUser.full_name;
            document.getElementById('pRole').textContent = currentUser.role;
            document.getElementById('avatarLetter').textContent = currentUser.full_name.charAt(0).toUpperCase();
            document.getElementById('pUsername').value = currentUser.username;
            document.getElementById('pEmail').value = currentUser.email;

            updateFaceStatusUI(currentUser.has_face_id);

        } catch (e) {
            console.error(e);
            showToast(e.message, 'error');
        }
    }

    function updateFaceStatusUI(hasFace) {
        const badge = document.getElementById('faceIdStatus');
        const startBtn = document.getElementById('startFaceBtn');
        const removeBtn = document.getElementById('removeFaceBtn');

        if (hasFace) {
            badge.textContent = "Active";
            badge.style.background = "#e6f4ea";
            badge.style.color = "#1e8e3e";
            badge.style.padding = "4px 12px";
            badge.style.borderRadius = "20px";

            startBtn.style.display = 'none';
            removeBtn.style.display = 'block';
        } else {
            badge.textContent = "Not Setup";
            badge.style.background = "#fce8e6";
            badge.style.color = "#c5221f";
            badge.style.padding = "4px 12px";
            badge.style.borderRadius = "20px";

            startBtn.style.display = 'block';
            removeBtn.style.display = 'none';
        }
    }

    async function startFaceEnrollment() {
        document.getElementById('faceActionContainer').style.display = 'none';
        document.getElementById('cameraSection').style.display = 'block';
        await startCamera();
    }

    function cancelFaceEnrollment() {
        stopCamera();
        document.getElementById('cameraSection').style.display = 'none';
        document.getElementById('faceActionContainer').style.display = 'block';
        // Reset buttons
        document.getElementById('captureBtn').style.display = 'block';
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('camStatus').textContent = "Initializing...";
    }

    // --- Camera Logic ---
    async function startCamera() {
        const statusEl = document.getElementById('camStatus');
        statusEl.textContent = "Loading AI models...";

        if (!faceModelsLoaded) {
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                faceModelsLoaded = true;
            } catch (e) {
                showError("Failed to load AI models");
                return;
            }
        }

        statusEl.textContent = "Starting camera...";
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            const video = document.getElementById('video');
            video.srcObject = stream;

            video.addEventListener('play', () => {
                const canvas = document.getElementById('canvas');

                const checkVideo = setInterval(() => {
                    if (video.videoWidth > 0 && video.videoHeight > 0) {
                        clearInterval(checkVideo);
                        const displaySize = { width: video.clientWidth, height: video.clientHeight };
                        faceapi.matchDimensions(canvas, displaySize);
                        statusEl.textContent = "Position your face in the frame";
                        startDetectionLoop(video, canvas, displaySize, statusEl);
                    }
                }, 100);
            });
        } catch (err) {
            showError("Camera error: " + err.message);
            cancelFaceEnrollment();
        }
    }

    function startDetectionLoop(video, canvas, displaySize, statusEl) {
        const intervalId = setInterval(async () => {
            if (document.getElementById('cameraSection').style.display === 'none') {
                clearInterval(intervalId);
                return;
            }
            // Stop detecting if we've already captured a descriptor and are waiting to save
            if (faceDescriptor && document.getElementById('saveBtn').style.display === 'block') return;

            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks().withFaceDescriptor();

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (detections) {
                const resized = faceapi.resizeResults(detections, displaySize);
                faceapi.draw.drawDetections(canvas, resized);
                statusEl.textContent = "Face detected!";
                statusEl.style.color = "#1e8e3e";
                document.getElementById('captureBtn').disabled = false;
                window.lastDescriptor = detections.descriptor;
            } else {
                statusEl.textContent = "Looking for face...";
                statusEl.style.color = "#5f6368";
                document.getElementById('captureBtn').disabled = true;
            }
        }, 500);
    }

    function captureFace() {
        if (window.lastDescriptor) {
            faceDescriptor = Array.from(window.lastDescriptor);
            document.getElementById('camStatus').textContent = "Γ£à Face captured!";
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'block';
            stopCamera();
        }
    }

    function stopCamera() {
        if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        const video = document.getElementById('video');
        if (video) video.srcObject = null;
    }

    async function saveFace() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.textContent = "Saving...";

        try {
            const res = await api('PUT', '/auth/me', { face_descriptor: faceDescriptor });
            currentUser = res;
            setAuth(getToken(), currentUser);
            showToast("Face ID set successfully!");
            cancelFaceEnrollment();
            updateFaceStatusUI(currentUser.has_face_id);
        } catch (e) {
            showError(e.message);
            btn.disabled = false;
            btn.textContent = "Save Face ID";
        }
    }

    // Stub for removing face ID - functionality would need backend support
    // For now it just shows a toast as it wasn't explicitly requested
    async function removeFaceId() {
        if (!confirm("Are you sure you want to remove Face ID?")) return;
        // Ideally: await api('DELETE', '/auth/me/face');
        showToast("Feature coming soon", "info");
    }

    function showError(msg) {
        const el = document.getElementById('profileError');
        el.textContent = msg;
        el.style.display = 'block';
    }
</script>
{% endblock %}
