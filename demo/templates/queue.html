{% extends "base.html" %}
{% block title %}Grievance Queue — PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content wide">
  <h1><span class="icon" style="font-size:28px;">list_alt</span> Grievance Queue</h1>
  <p class="subtitle">Filter and manage citizen grievances</p>
  <div class="filter-bar">
    <div class="form-group"><label>Status</label>
      <select class="form-control" id="fStatus"><option value="">All</option><option value="pending">Pending</option><option value="in_progress">In Progress</option><option value="resolved">Resolved</option><option value="escalated">Escalated</option></select></div>
    <div class="form-group"><label>Department</label><select class="form-control" id="fDept"></select></div>
    <div class="form-group"><label>Priority</label>
      <select class="form-control" id="fPriority"><option value="">All</option><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="urgent">Urgent</option></select></div>
    <div class="form-group"><label>District</label><select class="form-control" id="fDistrict"></select></div>
    <div class="form-group"><label>Sort</label>
      <select class="form-control" id="fSort"><option value="date">By Date + Priority</option><option value="impact">By Impact Score</option></select></div>
    <div class="form-group"><label>Search</label><input type="text" class="form-control" id="fSearch" placeholder="Search..."></div>
  </div>
  <div id="queueCount" class="text-sm text-muted mb-1"></div>
  <div id="queueList"></div>
</div>
{% endblock %}
{% block scripts %}
<style>
/* Queue-specific styles are now in the main stylesheet */
</style>
<script>
if (requireAuth()) {
  document.getElementById('fDept').innerHTML = deptOptions('', true);
  document.getElementById('fDistrict').innerHTML = '<option value="">All Districts</option>' +
    ODISHA_DISTRICTS.map(d => `<option value="${d}">${d}</option>`).join('');
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('district')) document.getElementById('fDistrict').value = urlParams.get('district');
  if (urlParams.get('status')) document.getElementById('fStatus').value = urlParams.get('status');
  if (urlParams.get('search')) document.getElementById('fSearch').value = urlParams.get('search');
  const queueUser = getUser();
  if (queueUser && queueUser.role === 'officer' && queueUser.department && !urlParams.get('department')) {
    document.getElementById('fDept').value = queueUser.department;
  }
  loadQueue();
  ['fStatus','fDept','fPriority','fDistrict','fSort'].forEach(id => document.getElementById(id).addEventListener('change', loadQueue));
  document.getElementById('fSearch').addEventListener('input', debounce(loadQueue, 300));
}

function debounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
function impactColor(s) { return s<=30?'#66BB6A':s<=60?'#FFB74D':s<=80?'#FF7043':'#EF5350'; }

async function loadQueue() {
  showLoading('queueList');
  const params = new URLSearchParams();
  const s = document.getElementById('fStatus').value; if (s) params.set('status', s);
  const d = document.getElementById('fDept').value; if (d) params.set('department', d);
  const p = document.getElementById('fPriority').value; if (p) params.set('priority', p);
  const dist = document.getElementById('fDistrict').value; if (dist) params.set('district', dist);
  const sortBy = document.getElementById('fSort').value;
  if (sortBy === 'impact') params.set('sort_by', 'impact_score');
  else params.set('group_by_date', 'true');
  params.set('limit', '50');
  try {
    let grievances = await api('GET', '/grievances?' + params.toString());
    const search = document.getElementById('fSearch').value.toLowerCase();
    if (search) grievances = grievances.filter(g => g.title.toLowerCase().includes(search) || g.description.toLowerCase().includes(search));
    document.getElementById('queueCount').textContent = `${grievances.length} grievances found`;
    const list = document.getElementById('queueList');
    if (!grievances.length) { list.innerHTML = '<div class="card text-center" style="padding:2rem;">No matching grievances.</div>'; return; }

    const now = new Date();
    if (sortBy === 'date') {
      // Group by date
      const groups = {};
      grievances.forEach(g => {
        const dateKey = new Date(g.created_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
        if (!groups[dateKey]) groups[dateKey] = [];
        groups[dateKey].push(g);
      });
      let html = '';
      for (const [date, items] of Object.entries(groups)) {
        html += `<div class="date-group-header"><span class="icon sm">calendar_today</span><h3>${date}</h3><span class="count">${items.length}</span></div>`;
        html += items.map(g => renderQueueCard(g, now)).join('');
      }
      list.innerHTML = html;
    } else {
      list.innerHTML = grievances.map(g => renderQueueCard(g, now)).join('');
    }
    document.querySelectorAll('.queue-card').forEach(card => {
      card.addEventListener('click', () => { window.location.href = '/grievance-detail?id=' + encodeURIComponent(card.dataset.id); });
    });
  } catch (e) { showToast(e.message, 'error'); }
}

function renderQueueCard(g, now) {
  const breached = (g.sla_deadline && new Date(g.sla_deadline) < now && g.status !== 'resolved') ||
                   (g.estimated_resolution_deadline && new Date(g.estimated_resolution_deadline) < now && g.status !== 'resolved');
  const breachBadge = breached ? '<span class="breach-indicator"><span class="icon sm">schedule</span> DEADLINE BREACHED</span>' : '';
  const impactBadge = g.impact_score != null ? `<span class="impact-circle-sm" style="background:${impactColor(g.impact_score)}">${g.impact_score}</span>` : '';
  const multiDept = g.sub_tasks?.length > 0 ? '<span class="multi-dept-badge"><span class="icon sm">link</span> Multi-Dept</span>' : '';
  const systemic = g.systemic_issue_id ? '<span class="systemic-badge"><span class="icon sm">error</span> Systemic</span>' : '';
  return `
    <div class="grievance-card card-animate status-${escapeHtml(g.status)} queue-card" data-id="${escapeHtml(g.id)}" style="cursor:pointer;">
      <div style="display:flex;align-items:center;gap:0.5rem;">
        ${impactBadge}
        <h4 style="margin:0;flex:1;">#${escapeHtml(g.tracking_number)} — ${escapeHtml(g.title)}</h4>
      </div>
      <p style="margin:0.3rem 0;">${escapeHtml(g.description).substring(0, 140)}...</p>
      <div class="badges">
        ${statusBadge(g.status)} ${deptBadge(g.department)} ${priorityBadge(g.priority)}
        <span class="badge badge-dept"><span class="icon sm">location_on</span> ${escapeHtml(g.district || 'N/A')}</span>
        <span class="badge badge-dept">${g.is_anonymous ? '<span class="icon sm">visibility_off</span> Anonymous' : '<span class="icon sm">person</span> ' + escapeHtml(g.citizen_name || 'N/A')}</span>
        ${breachBadge} ${multiDept} ${systemic}
      </div>
    </div>`;
}
</script>
{% endblock %}
