{% extends "base.html" %}
{% block title %}Officer Dashboard — PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content wide">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;">
    <div>
      <h1 style="margin-bottom:0;">Officer Dashboard</h1>
      <p class="subtitle" style="margin-top:0.25rem;">System overview, district map, and recent activity</p>
    </div>
    <div id="deptToggleWrap" style="display:none;">
      <div style="display:inline-flex;border-radius:10px;overflow:hidden;border:1px solid var(--outline-variant);font-size:0.85rem;">
        <button id="btnMyDept" onclick="setDeptScope('mine')" style="padding:0.4rem 1rem;border:none;cursor:pointer;font-weight:600;transition:all .2s;">My Department</button>
        <button id="btnAllDept" onclick="setDeptScope('all')" style="padding:0.4rem 1rem;border:none;cursor:pointer;font-weight:600;transition:all .2s;">All Departments</button>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="card-grid-6 mb-3" id="kpis"></div>

  <!-- Status Distribution Bar -->
  <div class="card mb-3" style="padding:1rem 1.5rem;" id="statusBarSection">
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem;">
      <h3 style="margin:0;">Status Overview</h3>
      <span id="statusBarLabel" class="text-sm text-muted"></span>
    </div>
    <div id="statusBar" style="display:flex;height:28px;border-radius:14px;overflow:hidden;background:var(--surface-container);"></div>
    <div id="statusLegend" style="display:flex;gap:1.5rem;margin-top:0.5rem;flex-wrap:wrap;"></div>
  </div>

  <!-- Main two-column: Recent Grievances (left) + District Map (right) -->
  <div class="dash-columns mb-3">
    <!-- Recent Grievances -->
    <div id="recentCard" class="card" style="padding:1.25rem;overflow:hidden;display:flex;flex-direction:column;min-height:0;">
      <h3 style="margin:0 0 0.75rem;">Recent Grievances</h3>
      <div id="recentList" style="flex:1;overflow-y:auto;min-height:0;"></div>
    </div>

    <!-- District Map -->
    <div id="mapCard" class="card" style="padding:1.25rem;display:flex;flex-direction:column;min-height:0;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.5rem;">
        <h3 style="margin:0;">District Map</h3>
        <div id="mapLegend" style="display:flex;align-items:center;gap:0.4rem;font-size:0.75rem;"></div>
      </div>
      <p class="text-sm text-muted" style="margin:0 0 0.5rem;">Click a district to view its queue</p>
      <div id="mapContainer" style="position:relative;flex:1;min-height:0;overflow:hidden;">
        <svg id="odishaMap" viewBox="0 0 800 650" preserveAspectRatio="xMidYMid meet"
             style="width:100%;height:100%;border-radius:10px;"></svg>
        <div id="mapTooltip" style="position:absolute;display:none;pointer-events:none;background:rgba(26,26,46,0.92);
             color:#fff;padding:0.4rem 0.7rem;border-radius:8px;font-size:0.82rem;box-shadow:0 4px 16px rgba(0,0,0,0.25);
             backdrop-filter:blur(8px);white-space:nowrap;z-index:10;"></div>
      </div>
    </div>
  </div>

  <!-- Systemic Issues Section -->
  <div class="card mb-3" style="padding:1.25rem;" id="systemicSection">
    <h3 style="margin:0 0 0.75rem;"><span class="icon filled" style="color:var(--error);font-size:18px;">error</span> Systemic Issues Detected</h3>
    <div id="systemicList"><div class="text-sm text-muted">Loading...</div></div>
  </div>

  <!-- Predictive Briefing Section -->
  <div class="card mb-3" style="padding:1.25rem;" id="forecastSection">
    <h3 style="margin:0 0 0.75rem;"><span class="icon" style="font-size:18px;">analytics</span> Predictive Briefing</h3>
    <div id="forecastContent"><div class="text-sm text-muted">Loading...</div></div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<style>
  .card-grid-6 { display: flex; gap: 0.75rem; flex-wrap: nowrap; }
  .card-grid-6 > * { flex: 1 1 0; min-width: 0; }
  .status-segment { transition: width 0.6s ease; min-width: 2px; }
  .status-legend-item { display: flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; }
  .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

  /* Two-column layout */
  .dash-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    align-items: stretch;
  }

  /* Recent grievances compact cards */
  #recentList .grievance-card {
    padding: 0.7rem 0.9rem !important;
    margin-bottom: 0.5rem;
  }
  #recentList .grievance-card h4 {
    font-size: 0.85rem;
    margin: 0 0 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #recentList .grievance-card p {
    font-size: 0.78rem;
    margin: 0 0 0.35rem;
    line-height: 1.3;
    color: var(--on-surface-variant);
  }
  #recentList .badges { gap: 0.3rem; flex-wrap: wrap; }
  #recentList .badge { font-size: 0.7rem; padding: 0.15rem 0.4rem; }

  /* SVG Map styles */
  #odishaMap .district-path {
    stroke: rgba(0, 0, 0, 0.35);
    stroke-width: 1;
    stroke-linejoin: round;
    cursor: pointer;
    transition: fill 0.25s ease, stroke-width 0.2s ease, filter 0.2s ease;
  }
  #odishaMap .district-path:hover {
    stroke: var(--on-surface);
    stroke-width: 2;
    filter: brightness(1.08) drop-shadow(0 2px 6px rgba(0,0,0,0.25));
  }
  #odishaMap .district-label {
    font-size: 13px;
    font-weight: 600;
    fill: var(--on-surface);
    text-anchor: middle;
    pointer-events: none;
    paint-order: stroke fill;
    stroke: var(--surface);
    stroke-width: 3px;
    stroke-linejoin: round;
  }
  .legend-bar {
    width: 140px; height: 10px; border-radius: 5px;
    background: linear-gradient(to right,
      hsl(130, 45%, 75%),
      hsl(90, 55%, 68%),
      hsl(55, 62%, 62%),
      hsl(25, 70%, 56%),
      hsl(0, 80%, 50%));
  }
  @media (max-width: 900px) {
    .dash-columns { grid-template-columns: 1fr; }
    .card-grid-6 { flex-wrap: wrap; }
    .card-grid-6 > * { flex: 1 1 calc(50% - 0.75rem); min-width: calc(50% - 0.75rem); }
    #recentList { max-height: 300px !important; }
  }
</style>
<script>
const STATUS_COLORS = {
  pending: '#E37400',
  in_progress: '#1A73E8',
  resolved: '#1E8E3E',
  escalated: '#D93025'
};
const STATUS_LABELS = {
  pending: 'Pending',
  in_progress: 'In Progress',
  resolved: 'Resolved',
  escalated: 'Escalated'
};

function heatColor(count, maxCount) {
  if (count === 0) return 'hsl(130, 30%, 90%)';
  const ratio = Math.min(count / Math.max(maxCount, 1), 1);
  const hue = 130 * (1 - Math.pow(ratio, 0.75));
  const sat = 45 + 35 * ratio;
  const lit = 75 - 25 * ratio;
  return `hsl(${hue.toFixed(0)}, ${sat.toFixed(0)}%, ${lit.toFixed(0)}%)`;
}

function textColor(count, maxCount) {
  const ratio = count / Math.max(maxCount, 1);
  return ratio > 0.5 ? '#fff' : '#1a1a2e';
}

let currentDeptScope = 'mine';
const dashUser = getUser();
const officerDept = (dashUser && dashUser.role === 'officer' && dashUser.department) ? dashUser.department : null;

(function initDeptToggle() {
  const wrap = document.getElementById('deptToggleWrap');
  if (officerDept) {
    wrap.style.display = '';
    updateToggleUI();
  }
})();

if (!requireAuth()) {}
else { loadOfficerDash(); }

function updateToggleUI() {
  const mine = document.getElementById('btnMyDept');
  const all = document.getElementById('btnAllDept');
  if (currentDeptScope === 'mine') {
    mine.style.background = 'var(--primary)'; mine.style.color = 'var(--on-primary)';
    all.style.background = 'var(--surface-container)'; all.style.color = 'var(--on-surface)';
  } else {
    all.style.background = 'var(--primary)'; all.style.color = 'var(--on-primary)';
    mine.style.background = 'var(--surface-container)'; mine.style.color = 'var(--on-surface)';
  }
}

function setDeptScope(scope) {
  currentDeptScope = scope;
  updateToggleUI();
  loadOfficerDash();
}

async function loadOfficerDash() {
  showLoading('kpis');
  try {
    const deptParam = (officerDept && currentDeptScope === 'mine') ? `&department=${encodeURIComponent(officerDept)}` : '';
    const [analytics, grievances] = await Promise.all([
      api('GET', '/analytics?days=30' + deptParam),
      api('GET', '/grievances?limit=10' + deptParam)
    ]);

    // --- KPI Cards (8) ---
    const deadlineAlerts = analytics.deadline_alerts || 0;
    document.getElementById('kpis').innerHTML = `
      <div class="metric-card card-animate"><div class="metric-icon blue"><span class="icon">assignment</span></div><div class="metric-value">${analytics.total_grievances}</div><div class="metric-label">Total (30d)</div></div>
      <div class="metric-card card-animate"><div class="metric-icon green"><span class="icon">check_circle</span></div><div class="metric-value">${analytics.self_resolved}</div><div class="metric-label">Self-Resolved</div></div>
      <div class="metric-card card-animate"><div class="metric-icon purple"><span class="icon">auto_awesome</span></div><div class="metric-value">${analytics.ai_drafted}</div><div class="metric-label">AI Drafted</div></div>
      <div class="metric-card card-animate"><div class="metric-icon red"><span class="icon">warning</span></div><div class="metric-value">${analytics.escalated_to_human}</div><div class="metric-label">Escalated</div></div>
      <div class="metric-card card-animate"><div class="metric-icon amber"><span class="icon">schedule</span></div><div class="metric-value">${analytics.avg_resolution_time}h</div><div class="metric-label">Avg Resolution</div></div>
      <div class="metric-card card-animate"><div class="metric-icon blue"><span class="icon">pending_actions</span></div><div class="metric-value">${analytics.pending_count}</div><div class="metric-label">Pending</div></div>
      <div class="metric-card card-animate" style="${analytics.sla_breached_count > 0 ? 'border:2px solid var(--error);' : ''}"><div class="metric-icon red"><span class="icon">error</span></div><div class="metric-value">${analytics.sla_breached_count}</div><div class="metric-label">SLA Breached</div></div>
      <div class="metric-card card-animate" style="${deadlineAlerts > 0 ? 'border:2px solid var(--warning);' : ''}"><div class="metric-icon amber"><span class="icon">notifications_active</span></div><div class="metric-value">${deadlineAlerts}</div><div class="metric-label">Deadline Alerts</div></div>`;

    // --- Status Distribution Bar ---
    const sd = analytics.status_distribution || {};
    const totalStatus = Object.values(sd).reduce((a, b) => a + b, 0) || 1;
    document.getElementById('statusBarLabel').textContent = `${totalStatus} total grievances`;
    let barHTML = '';
    let legendHTML = '';
    for (const [key, label] of Object.entries(STATUS_LABELS)) {
      const count = sd[key] || 0;
      const pct = ((count / totalStatus) * 100).toFixed(1);
      if (count > 0) {
        barHTML += `<div class="status-segment" style="width:${pct}%;background:${STATUS_COLORS[key]};" title="${label}: ${count} (${pct}%)"></div>`;
      }
      legendHTML += `<div class="status-legend-item"><span class="status-dot" style="background:${STATUS_COLORS[key]};"></span>${label}: ${count}</div>`;
    }
    document.getElementById('statusBar').innerHTML = barHTML;
    document.getElementById('statusLegend').innerHTML = legendHTML;

    // --- District Map ---
    const districtMap = {};
    (analytics.top_districts || []).forEach(d => { districtMap[d.district] = d.count; });
    const maxCount = Math.max(...Object.values(districtMap), 1);
    await renderDistrictMap(districtMap, maxCount);

    // --- Recent Grievances ---
    const list = document.getElementById('recentList');
    if (!grievances.length) { list.innerHTML = '<div class="text-center text-muted" style="padding:2rem;">No grievances yet.</div>'; return; }
    list.innerHTML = grievances.map(g => `
      <div class="grievance-card card-animate status-${escapeHtml(g.status)} recent-card" data-id="${escapeHtml(g.id)}" style="cursor:pointer;">
        <h4>#${escapeHtml(g.tracking_number)} — ${escapeHtml(g.title)}</h4>
        <p>${escapeHtml(g.description).substring(0, 80)}...</p>
        <div class="badges">
          ${statusBadge(g.status)} ${priorityBadge(g.priority)}
          <span class="badge badge-dept"><span class="icon sm">location_on</span> ${escapeHtml(g.district || 'N/A')}</span>
        </div>
      </div>`).join('');
    document.querySelectorAll('.recent-card').forEach(card => {
      card.addEventListener('click', () => { window.location.href = '/grievance-detail?id=' + encodeURIComponent(card.dataset.id); });
    });
    // Load systemic issues and forecasts in parallel
    loadSystemicIssues();
    loadForecast();
  } catch (e) { showToast(e.message, 'error'); }
}

async function loadSystemicIssues() {
  try {
    const issues = await api('GET', '/systemic-issues?status=detected');
    const el = document.getElementById('systemicList');
    if (!issues.length) { el.innerHTML = '<div class="text-sm text-muted">No systemic issues detected.</div>'; return; }
    el.innerHTML = issues.map(i => `
      <div class="card card-animate" style="padding:0.75rem;margin-bottom:0.5rem;border-left:4px solid #7C4DFF;cursor:pointer;" onclick="window.location.href='/systemic-issue-detail?id=${encodeURIComponent(i.id)}'">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>${escapeHtml(i.title)}</strong>
          <span class="badge badge-priority-${escapeHtml(i.priority)}">${escapeHtml(i.priority)}</span>
        </div>
        <div class="text-sm" style="margin-top:0.3rem;">${escapeHtml(i.department)} · ${escapeHtml(i.district || 'N/A')} · ${i.grievance_ids?.length || 0} linked grievances · Est. ${i.estimated_population_affected || '?'} people affected</div>
      </div>`).join('');
  } catch { document.getElementById('systemicList').innerHTML = '<div class="text-sm text-muted">Could not load systemic issues.</div>'; }
}

async function loadForecast() {
  try {
    const f = await api('GET', '/forecasts/latest');
    const el = document.getElementById('forecastContent');
    if (!f || f.detail === 'No forecasts available' || !f.predictions) {
      el.innerHTML = '<div class="text-sm text-muted">No forecasts available. Admins can generate one from the admin panel.</div>';
      return;
    }
    const spikes = (f.predictions || []).filter(p => p.spike_factor > 1.2).sort((a, b) => b.spike_factor - a.spike_factor).slice(0, 5);
    if (!spikes.length) {
      el.innerHTML = '<div class="text-sm">No significant spikes predicted for the coming period.</div>';
      return;
    }
    el.innerHTML = `<div class="text-sm text-muted mb-1">Period: ${formatDate(f.forecast_period_start)} – ${formatDate(f.forecast_period_end)}</div>` +
      spikes.map(p => `
        <div class="card card-animate" style="padding:0.75rem;margin-bottom:0.5rem;border-left:4px solid ${p.spike_factor >= 2 ? 'var(--error)' : 'var(--warning)'};">
          <strong>${escapeHtml(p.district)} — ${escapeHtml(deptLabel(p.department))}</strong>
          <span style="float:right;font-weight:700;color:${p.spike_factor >= 2 ? 'var(--error)' : 'var(--warning)'};">${p.spike_factor.toFixed(1)}x spike</span>
          <div class="text-sm" style="margin-top:0.3rem;">Baseline: ${p.baseline_count} → Predicted: ${p.predicted_count} · Triggers: ${p.triggers.join(', ')}</div>
          ${p.recommended_actions?.length ? '<div class="text-sm" style="margin-top:0.2rem;color:var(--primary);"><span class="icon sm">assignment</span> ' + p.recommended_actions.join(' | ') + '</div>' : ''}
        </div>`).join('');
  } catch { document.getElementById('forecastContent').innerHTML = '<div class="text-sm text-muted">Could not load forecast.</div>'; }
}


/* --------- SVG Map Rendering --------- */
let _geoData = null;
async function loadGeoData() {
  if (_geoData) return _geoData;
  const resp = await fetch('/static/odisha_districts.json');
  _geoData = await resp.json();
  return _geoData;
}

function geoProject(lon, lat, bounds, svgW, svgH, padding) {
  const [minLon, minLat, maxLon, maxLat] = bounds;
  const geoW = maxLon - minLon;
  const geoH = maxLat - minLat;
  const drawW = svgW - padding * 2;
  const drawH = svgH - padding * 2;
  const scale = Math.min(drawW / geoW, drawH / geoH);
  const offsetX = padding + (drawW - geoW * scale) / 2;
  const offsetY = padding + (drawH - geoH * scale) / 2;
  const x = offsetX + (lon - minLon) * scale;
  const y = offsetY + (maxLat - lat) * scale; // flip Y
  return [x, y];
}

function coordsToPath(ring, bounds, svgW, svgH, padding) {
  if (ring.length < 3) return ''; // skip degenerate rings
  return ring.map((c, i) => {
    const [x, y] = geoProject(c[0], c[1], bounds, svgW, svgH, padding);
    return (i === 0 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1);
  }).join(' ') + ' Z';
}

function centroid(ring) {
  let cx = 0, cy = 0;
  ring.forEach(c => { cx += c[0]; cy += c[1]; });
  return [cx / ring.length, cy / ring.length];
}

// Manual SVG-pixel offsets [dx, dy] to fix overlapping / misplaced labels
const LABEL_NUDGE = {
  'Deogarh':       [12, 10],
  'Sambalpur':     [-18, 8],
  'Subarnapur':    [0, 8],
  'Dhenkanal':     [0, -4],
  'Jajpur':        [8, 10],
  'Bhadrak':       [-38, -10],
  'Kendrapara':    [-12, 24],
  'Jagatsinghpur': [30, -30],
  'Khordha':       [-4, 10],
  'Puri':          [-86, 18],
  'Nayagarh':      [-18, 2],
  'Cuttack':       [0, -6],
  'Angul':         [0, 6],
  'Balasore':      [-26, 20],
  'Gajapati':      [-6, 4],
  'Ganjam':        [-4, -65],
  'Kandhamal':     [0, 0],
  'Boudh':         [4, -10],
};

async function renderDistrictMap(districtCounts, maxCount) {
  const geo = await loadGeoData();
  const svg = document.getElementById('odishaMap');
  const tooltip = document.getElementById('mapTooltip');

  // Compute bounding box
  let minLon = Infinity, minLat = Infinity, maxLon = -Infinity, maxLat = -Infinity;
  geo.features.forEach(f => {
    const rings = f.geometry.type === 'Polygon'
      ? f.geometry.coordinates
      : f.geometry.coordinates.flat(1);
    rings.forEach(ring => ring.forEach(c => {
      if (c[0] < minLon) minLon = c[0];
      if (c[0] > maxLon) maxLon = c[0];
      if (c[1] < minLat) minLat = c[1];
      if (c[1] > maxLat) maxLat = c[1];
    }));
  });
  const bounds = [minLon, minLat, maxLon, maxLat];
  const svgW = 800, svgH = 650, pad = 20;

  let pathsHTML = '';
  let labelsHTML = '';

  geo.features.forEach(f => {
    const name = f.properties.name;
    const count = districtCounts[name] || 0;
    const fillColor = heatColor(count, maxCount);

    // Build SVG path
    let d = '';
    if (f.geometry.type === 'Polygon') {
      f.geometry.coordinates.forEach(ring => {
        d += coordsToPath(ring, bounds, svgW, svgH, pad) + ' ';
      });
    } else {
      f.geometry.coordinates.forEach(polygon => {
        polygon.forEach(ring => {
          d += coordsToPath(ring, bounds, svgW, svgH, pad) + ' ';
        });
      });
    }

    pathsHTML += `<path class="district-path" d="${d.trim()}" style="fill:${fillColor}"
      data-district="${name}" data-count="${count}" />`;

    // Compute label centroid from outer ring + manual nudge
    const outerRing = f.geometry.type === 'Polygon'
      ? f.geometry.coordinates[0]
      : f.geometry.coordinates[0][0];
    const [cLon, cLat] = centroid(outerRing);
    let [cx, cy] = geoProject(cLon, cLat, bounds, svgW, svgH, pad);
    const nudge = LABEL_NUDGE[name];
    if (nudge) { cx += nudge[0]; cy += nudge[1]; }
    labelsHTML += `<text class="district-label" x="${cx.toFixed(1)}" y="${cy.toFixed(1)}">${name}</text>`;
  });

  svg.innerHTML = pathsHTML + labelsHTML;

  // Legend
  document.getElementById('mapLegend').innerHTML = `
    <span>0</span>
    <div class="legend-bar"></div>
    <span>${maxCount}</span>
  `;

  // Tooltip + click interactivity
  svg.querySelectorAll('.district-path').forEach(path => {
    path.addEventListener('mouseenter', e => {
      const name = path.dataset.district;
      const count = path.dataset.count;
      tooltip.innerHTML = `<strong>${name}</strong><br>${count} grievance${count !== '1' ? 's' : ''}`;
      tooltip.style.display = 'block';
    });
    path.addEventListener('mousemove', e => {
      const container = document.getElementById('mapContainer');
      const rect = container.getBoundingClientRect();
      tooltip.style.left = (e.clientX - rect.left + 12) + 'px';
      tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
    });
    path.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });
    path.addEventListener('click', () => {
      window.location.href = '/queue?district=' + encodeURIComponent(path.dataset.district);
    });
  });
}
</script>
{% endblock %}
