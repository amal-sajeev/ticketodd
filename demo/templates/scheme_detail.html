{% extends "base.html" %}
{% block title %}Scheme Details — PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content" style="max-width:800px;">
  <a href="/schemes" class="btn btn-secondary btn-sm mb-2">← Back to Schemes</a>
  <div id="schemeContent">
    <div class="spinner"><span></span><span></span><span></span></div>
  </div>
</div>

<!-- Document Viewer Modal -->
<!-- Document Viewer Modal -->
<div id="docViewerOverlay" class="doc-overlay hidden" onclick="closeDocViewer()">
  <div class="glass-strong doc-modal" onclick="event.stopPropagation()"
    style="display:flex;flex-direction:column;height:95vh;padding:0;">
    <div class="flex-between mb-1" style="padding:0.5rem 1rem;flex-shrink:0;">
      <h3 id="docViewerTitle" style="margin:0;"></h3>
      <button class="btn btn-sm" onclick="closeDocViewer()" style="padding:0.3rem 0.7rem;"
        aria-label="Close document viewer"><span class="icon sm">close</span></button>
    </div>
    <div id="loadingSpinner" class="hidden" style="text-align:center;padding:2rem;">
      <div class="spinner"><span></span><span></span><span></span></div>
      <p>Loading preview...</p>
    </div>
    <div id="docViewerContent"></div>
    <div id="pdfControls" class="hidden"
      style="display:flex;gap:0.5rem;align-items:center;justify-content:center;background:var(--surface-container);padding:0.5rem;border-radius:8px;flex-shrink:0;">
      <button class="btn btn-sm btn-secondary" onclick="changeZoom(-0.1)" aria-label="Zoom out"><span
          class="icon sm">remove</span></button>
      <span id="zoomLevel" style="font-size:0.9rem;font-weight:600;min-width:60px;text-align:center;">100%</span>
      <button class="btn btn-sm btn-secondary" onclick="changeZoom(0.1)" aria-label="Zoom in"><span
          class="icon sm">add</span></button>
      <button class="btn btn-sm btn-secondary" onclick="resetZoom()" style="margin-left:0.5rem;"
        aria-label="Reset zoom">Reset</button>
    </div>
    <div id="pdfContainer" class="hidden"
      style="flex:1;overflow:auto;background:#525659;border-radius:4px;min-height:0;"></div>
    <div id="imageContainer" class="hidden" style="text-align:center;flex:1;overflow:auto;min-height:0;">
      <img id="viewerImage" src="" style="max-width:100%;height:auto;border-radius:4px;">
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<script>
  const schemeId = new URLSearchParams(window.location.search).get('id');
  let schemeData = null;
  let answers = {};

  if (!schemeId) {
    document.getElementById('schemeContent').innerHTML = '<p>No scheme ID provided.</p>';
  } else {
    loadScheme();
  }

  async function loadScheme() {
    try {
      schemeData = await api('GET', `/knowledge/schemes/${schemeId}`);
      renderScheme();
    } catch (e) {
      document.getElementById('schemeContent').innerHTML = `<div class="card" style="padding:2rem;text-align:center;"><p style="color:var(--error);">Scheme not found.</p></div>`;
    }
  }

  function renderScheme() {
    const s = schemeData;
    const questions = s.eligibility_questions || [];
    const hasQuestions = questions.length > 0;

    document.getElementById('schemeContent').innerHTML = `
    <div class="card card-animate" style="padding:2rem;">
      <div class="flex-between mb-1">
        <h1 style="font-size:1.5rem;margin-bottom:0;">${escapeHtml(s.name)}</h1>
        ${deptBadge(s.department)}
      </div>
      <p style="line-height:1.7;margin-bottom:1rem;">${escapeHtml(s.description)}</p>
      <div class="detail-section">
        <h3>Eligibility Criteria</h3>
        <p style="line-height:1.7;color:#37474F;">${escapeHtml(s.eligibility)}</p>
      </div>
      <div class="detail-section">
        <h3>How to Apply</h3>
        <p style="line-height:1.7;color:#37474F;">${escapeHtml(s.how_to_apply)}</p>
      </div>

      ${(s.documents || []).length ? `
      <div class="detail-section">
        <h3>Reference Documents</h3>
        ${s.documents.map(doc => `
          <div class="upload-file-item">
            <span class="upload-file-name">${escapeHtml(doc.filename)}</span>
            <span class="upload-file-meta">${formatBytes(doc.size || 0)}</span>
            <button class="btn btn-sm btn-secondary" style="padding:0.2rem 0.6rem;font-size:0.75rem;" onclick="openDocViewer('${doc.id}','${escapeHtml(doc.filename)}','${doc.content_type}')">View</button>
          </div>`).join('')}
      </div>
      ` : ''}
    </div>

    ${hasQuestions ? `
    <div class="card card-animate mt-2" style="padding:2rem;" id="questionnaireCard">
      <h2 style="margin-bottom:0.25rem;">Check Your Eligibility</h2>
      <p class="text-sm text-muted mb-2">Answer these simple questions to see if you may be eligible.</p>
      <div id="questionsList"></div>
      <button class="btn btn-primary btn-block mt-2" id="checkBtn" onclick="checkEligibility()" disabled>Check My Eligibility</button>
    </div>
    <div id="resultArea" class="hidden mt-2"></div>
    ` : `
    <div class="card mt-2" style="padding:1.5rem;text-align:center;">
      <p class="text-muted">Eligibility questionnaire not yet available for this scheme. Please review the criteria above.</p>
    </div>
    `}`;

    if (hasQuestions) renderQuestions(questions);
  }

  function renderQuestions(questions) {
    const el = document.getElementById('questionsList');
    answers = {};
    el.innerHTML = questions.map((q, i) => `
    <div class="card" style="padding:1rem 1.25rem;margin-bottom:0.75rem;">
      <p style="font-weight:500;margin-bottom:0.75rem;">${i + 1}. ${escapeHtml(q.question)}</p>
      <div class="flex gap-1">
        <button class="btn btn-sm answer-btn" data-q="${i}" data-val="yes" onclick="selectAnswer(${i}, 'yes', this)"
          style="min-width:80px;background:var(--primary-container-low);color:var(--on-surface);border:2px solid transparent;">Yes</button>
        <button class="btn btn-sm answer-btn" data-q="${i}" data-val="no" onclick="selectAnswer(${i}, 'no', this)"
          style="min-width:80px;background:var(--primary-container-low);color:var(--on-surface);border:2px solid transparent;">No</button>
      </div>
    </div>`).join('');
  }

  function selectAnswer(index, value, btn) {
    answers[index] = value;
    // Reset siblings
    btn.parentElement.querySelectorAll('.answer-btn').forEach(b => {
      b.style.border = '2px solid transparent';
      b.style.background = 'var(--primary-container-low)';
      b.style.color = 'var(--on-surface)';
    });
    // Highlight selected
    if (value === 'yes') {
      btn.style.border = '2px solid var(--success)'; btn.style.background = 'var(--success-container)'; btn.style.color = 'var(--success)';
    } else {
      btn.style.border = '2px solid var(--error)'; btn.style.background = 'var(--error-container)'; btn.style.color = 'var(--error)';
    }
    // Enable check button when all answered
    const total = (schemeData.eligibility_questions || []).length;
    document.getElementById('checkBtn').disabled = Object.keys(answers).length < total;
  }

  function checkEligibility() {
    const questions = schemeData.eligibility_questions || [];
    let matches = 0;
    questions.forEach((q, i) => {
      if (answers[i] === q.eligible_answer) matches++;
    });
    const total = questions.length;
    const pct = total > 0 ? (matches / total) * 100 : 0;
    const resultEl = document.getElementById('resultArea');
    resultEl.classList.remove('hidden');

    let color, iconHtml, title, message;
    if (pct === 100) {
      color = 'var(--success-container)'; iconHtml = '<span class="icon filled" style="font-size:2.5rem;">check_circle</span>'; title = 'You Appear Eligible!';
      message = `You matched all ${total} criteria. Here's how to apply:<br><br><strong>${escapeHtml(schemeData.how_to_apply)}</strong>`;
    } else if (pct >= 50) {
      color = 'var(--primary-container-low)'; iconHtml = '<span class="icon filled" style="font-size:2.5rem;">warning</span>'; title = 'You May Be Partially Eligible';
      message = `You matched ${matches} out of ${total} criteria. You may still qualify — we recommend contacting the ${deptLabel(schemeData.department)} department for clarification.`;
    } else {
      color = 'var(--error-container)'; iconHtml = '<span class="icon filled" style="font-size:2.5rem;">error</span>'; title = 'You May Not Be Eligible';
      message = `You matched ${matches} out of ${total} criteria. This scheme may not be the right fit, but you can <a href="/schemes" class="auth-link">browse other schemes</a> or <a href="/chatbot" class="auth-link">ask the chatbot</a> for help.`;
    }

    resultEl.innerHTML = `
    <div class="card card-animate" style="padding:2rem;text-align:center;background:${color};">
      <div style="font-size:2.5rem;margin-bottom:0.5rem;">${iconHtml}</div>
      <h2>${title}</h2>
      <p style="margin-top:0.75rem;line-height:1.7;">${message}</p>
    </div>`;

    resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // --- Helpers ---
  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // ===================================================================
  // DOCUMENT VIEWER (PDF.js + Image)
  // ===================================================================
  let pdfDoc = null, scale = 1.0;

  async function openDocViewer(docId, filename, contentType) {
    const overlay = document.getElementById('docViewerOverlay');
    const title = document.getElementById('docViewerTitle');
    const content = document.getElementById('docViewerContent');
    const pdfControls = document.getElementById('pdfControls');
    const pdfContainer = document.getElementById('pdfContainer');
    const imgContainer = document.getElementById('imageContainer');
    const viewerImg = document.getElementById('viewerImage');
    const loader = document.getElementById('loadingSpinner');

    title.textContent = filename;
    title.title = filename;
    const url = `/attachments/${docId}`;

    // Reset state
    pdfDoc = null;
    pdfControls.classList.add('hidden');
    pdfContainer.classList.add('hidden');
    pdfContainer.innerHTML = '';
    imgContainer.classList.add('hidden');
    content.innerHTML = '';
    loader.classList.remove('hidden');
    overlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    if (contentType === 'application/pdf') {
      if (typeof pdfjsLib !== 'undefined') {
        try {
          const loadingTask = pdfjsLib.getDocument(url);
          pdfDoc = await loadingTask.promise;

          pdfControls.classList.remove('hidden');
          pdfContainer.classList.remove('hidden');
          loader.classList.add('hidden');

          // Initial seamless fit
          fitToWidth();
        } catch (e) {
          loader.classList.add('hidden');
          console.error(e);
          // Fallback to iframe if pdf.js fails
          pdfContainer.classList.remove('hidden');
          pdfContainer.innerHTML = `<iframe src="${url}" style="width:100%;height:100%;min-height:70vh;border:none;border-radius:8px;"></iframe>`;
        }
      } else {
        // Fallback: use browser's built-in PDF viewer via iframe
        loader.classList.add('hidden');
        pdfContainer.classList.remove('hidden');
        pdfContainer.innerHTML = `<iframe src="${url}" style="width:100%;height:100%;min-height:70vh;border:none;border-radius:8px;"></iframe>`;
      }
    } else if (contentType && contentType.startsWith('image/')) {
      viewerImg.src = url;
      loader.classList.add('hidden');
      imgContainer.classList.remove('hidden');
    } else {
      loader.classList.add('hidden');
      content.innerHTML = `<div style="padding:2rem;text-align:center;color:#37474F;"><p>Preview not available for this file type.</p><a href="${url}" target="_blank" class="btn btn-primary btn-sm mt-1">Download</a></div>`;
    }
  }

  async function fitToWidth() {
    if (!pdfDoc) return;
    const container = document.getElementById('docViewerContent');
    const page = await pdfDoc.getPage(1);
    const viewport = page.getViewport({ scale: 1 });

    // Exact fit to container width (no margins)
    // Subtract scrollbar width approximation (approx 16px if needed, or use clientWidth)
    const availableWidth = container.clientWidth - 30; // 30px safety margin for scrollbar + padding

    scale = availableWidth / viewport.width;
    renderAllPages();
  }

  async function renderAllPages() {
    const container = document.getElementById('pdfContainer');
    container.innerHTML = '';

    // Update Zoom Label
    const pct = Math.round(scale * 100);
    document.getElementById('zoomLevel').textContent = pct + '%';

    for (let num = 1; num <= pdfDoc.numPages; num++) {
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: scale });

      const canvas = document.createElement('canvas');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      canvas.style.display = 'block';

      // Styling for seamless look
      canvas.style.marginBottom = '20px'; // Slight gap between pages
      canvas.style.background = '#FFFFFF';
      canvas.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)'; // Subtle shadow

      container.appendChild(canvas);

      const ctx = canvas.getContext('2d');
      const renderContext = { canvasContext: ctx, viewport: viewport };
      page.render(renderContext);
    }
  }

  function changeZoom(delta) {
    if (!pdfDoc) return;
    const newScale = scale + delta;
    if (newScale >= 0.2 && newScale <= 5.0) {
      scale = newScale;
      renderAllPages();
    }
  }

  function resetZoom() {
    fitToWidth();
  }

  function closeDocViewer() {
    document.getElementById('docViewerOverlay').classList.add('hidden');
    document.getElementById('docViewerContent').innerHTML = '';
    document.getElementById('pdfContainer').innerHTML = '';
    document.body.style.overflow = '';
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !document.getElementById('docViewerOverlay').classList.contains('hidden')) closeDocViewer();
  });
</script>
{% endblock %}