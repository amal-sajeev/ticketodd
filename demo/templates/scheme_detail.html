{% extends "base.html" %}
{% block title %}Scheme Details ‚Äî PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content" style="max-width:800px;">
  <a href="/schemes" class="btn btn-secondary btn-sm mb-2">‚Üê Back to Schemes</a>
  <div id="schemeContent">
    <div class="spinner"><span></span><span></span><span></span></div>
  </div>
</div>

<!-- Document Viewer Modal -->
<div id="docViewerOverlay" class="hidden"
  style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.4);z-index:2000;backdrop-filter:blur(5px);display:flex;justify-content:center;align-items:center;">

  <!-- Glass Container (Frutiger Aero Style) -->
  <div class="glass-strong"
    style="width:1000px;max-width:98vw;height:95vh;display:flex;flex-direction:column;box-shadow:0 30px 80px rgba(0,0,0,0.2);overflow:hidden;background:rgba(255,255,255,0.65);border-radius:16px;">

    <!-- Toolbar -->
    <div
      style="height:60px;padding:0 1.5rem;border-bottom:1px solid rgba(255,255,255,0.5);display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.3);">
      <div style="display:flex;align-items:center;gap:0.75rem;overflow:hidden;">
        <div
          style="width:32px;height:32px;border-radius:8px;background:rgba(21,101,192,0.1);color:#1565C0;display:flex;align-items:center;justify-content:center;font-size:1.1rem;">
          üìÑ</div>
        <h3 id="docViewerTitle"
          style="margin:0;color:#0D47A1;font-size:1.1rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          Document</h3>
      </div>

      <div id="pdfControls" class="flex hidden"
        style="align-items:center;background:rgba(255,255,255,0.5);border-radius:50px;padding:4px 6px;border:1px solid rgba(255,255,255,0.6);box-shadow:0 2px 5px rgba(0,0,0,0.05);">
        <button onclick="zoomPdf(-0.2)"
          style="width:32px;height:32px;border-radius:50%;border:none;background:transparent;color:#1565C0;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;">‚àí</button>
        <button onclick="fitToWidth()"
          style="padding:0 12px;height:32px;border:none;background:transparent;color:#0D47A1;font-size:0.85rem;font-weight:600;cursor:pointer;"
          id="zoomLevel">Fit</button>
        <button onclick="zoomPdf(0.2)"
          style="width:32px;height:32px;border-radius:50%;border:none;background:transparent;color:#1565C0;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;">+</button>
      </div>

      <div class="flex">
        <button onclick="closeDocViewer()"
          style="width:36px;height:36px;border-radius:50%;border:1px solid rgba(239,83,80,0.3);background:rgba(239,83,80,0.1);color:#D32F2F;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:all 0.2s;"
          onmouseover="this.style.background='rgba(239,83,80,0.2)'"
          onmouseout="this.style.background='rgba(239,83,80,0.1)'">‚úï</button>
      </div>
    </div>

    <!-- Content Area -->
    <div id="docViewerContent"
      style="flex:1;overflow-y:auto;overflow-x:hidden;background:transparent;position:relative;scroll-behavior:smooth;padding:0;">
      <div id="pdfContainer" class="hidden"
        style="display:flex;flex-direction:column;align-items:center;width:100%;min-height:100%;background:transparent;">
        <!-- Pages injected here -->
      </div>
      <div id="imageContainer" class="hidden"
        style="width:100%;height:100%;display:flex;justify-content:center;align-items:center;padding:2rem;">
        <img id="viewerImage" src=""
          style="max-width:100%;max-height:100%;object-fit:contain;filter:drop-shadow(0 10px 20px rgba(0,0,0,0.15));">
      </div>
      <div id="loadingSpinner" class="spinner hidden"
        style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<script>
  const schemeId = new URLSearchParams(window.location.search).get('id');
  let schemeData = null;
  let answers = {};

  if (!schemeId) {
    document.getElementById('schemeContent').innerHTML = '<p>No scheme ID provided.</p>';
  } else {
    loadScheme();
  }

  async function loadScheme() {
    try {
      schemeData = await api('GET', `/knowledge/schemes/${schemeId}`);
      renderScheme();
    } catch (e) {
      document.getElementById('schemeContent').innerHTML = `<div class="glass card" style="padding:2rem;text-align:center;"><p style="color:#C62828;">Scheme not found.</p></div>`;
    }
  }

  function renderScheme() {
    const s = schemeData;
    const questions = s.eligibility_questions || [];
    const hasQuestions = questions.length > 0;

    document.getElementById('schemeContent').innerHTML = `
    <div class="glass-strong card card-animate" style="padding:2rem;">
      <div class="flex-between mb-1">
        <h1 style="font-size:1.5rem;margin-bottom:0;">${escapeHtml(s.name)}</h1>
        ${deptBadge(s.department)}
      </div>
      <p style="line-height:1.7;margin-bottom:1rem;">${escapeHtml(s.description)}</p>
      <div class="detail-section">
        <h3>Eligibility Criteria</h3>
        <p style="line-height:1.7;color:#37474F;">${escapeHtml(s.eligibility)}</p>
      </div>
      <div class="detail-section">
        <h3>How to Apply</h3>
        <p style="line-height:1.7;color:#37474F;">${escapeHtml(s.how_to_apply)}</p>
      </div>

      ${(s.documents || []).length ? `
      <div class="detail-section">
        <h3>Reference Documents</h3>
        ${s.documents.map(doc => `
          <div class="upload-file-item">
            <span class="upload-file-name">${escapeHtml(doc.filename)}</span>
            <span class="upload-file-meta">${formatBytes(doc.size || 0)}</span>
            <button class="btn btn-sm btn-secondary" style="padding:0.2rem 0.6rem;font-size:0.75rem;" onclick="openDocViewer('${doc.id}','${escapeHtml(doc.filename)}','${doc.content_type}')">View</button>
          </div>`).join('')}
      </div>
      ` : ''}
    </div>

    ${hasQuestions ? `
    <div class="glass-strong card card-animate mt-2" style="padding:2rem;" id="questionnaireCard">
      <h2 style="margin-bottom:0.25rem;">Check Your Eligibility</h2>
      <p class="text-sm text-muted mb-2">Answer these simple questions to see if you may be eligible.</p>
      <div id="questionsList"></div>
      <button class="btn btn-primary btn-block mt-2" id="checkBtn" onclick="checkEligibility()" disabled>Check My Eligibility</button>
    </div>
    <div id="resultArea" class="hidden mt-2"></div>
    ` : `
    <div class="glass card mt-2" style="padding:1.5rem;text-align:center;">
      <p class="text-muted">Eligibility questionnaire not yet available for this scheme. Please review the criteria above.</p>
    </div>
    `}`;

    if (hasQuestions) renderQuestions(questions);
  }

  function renderQuestions(questions) {
    const el = document.getElementById('questionsList');
    answers = {};
    el.innerHTML = questions.map((q, i) => `
    <div class="glass card" style="padding:1rem 1.25rem;margin-bottom:0.75rem;">
      <p style="font-weight:500;margin-bottom:0.75rem;">${i + 1}. ${escapeHtml(q.question)}</p>
      <div class="flex gap-1">
        <button class="btn btn-sm answer-btn" data-q="${i}" data-val="yes" onclick="selectAnswer(${i}, 'yes', this)"
          style="min-width:80px;background:rgba(255,255,255,0.25);color:#37474F;border:2px solid transparent;">Yes</button>
        <button class="btn btn-sm answer-btn" data-q="${i}" data-val="no" onclick="selectAnswer(${i}, 'no', this)"
          style="min-width:80px;background:rgba(255,255,255,0.25);color:#37474F;border:2px solid transparent;">No</button>
      </div>
    </div>`).join('');
  }

  function selectAnswer(index, value, btn) {
    answers[index] = value;
    // Reset siblings
    btn.parentElement.querySelectorAll('.answer-btn').forEach(b => {
      b.style.border = '2px solid transparent';
      b.style.background = 'rgba(255,255,255,0.25)';
      b.style.color = '#37474F';
    });
    // Highlight selected
    if (value === 'yes') {
      btn.style.border = '2px solid #2E7D32'; btn.style.background = 'rgba(46,125,50,0.15)'; btn.style.color = '#2E7D32';
    } else {
      btn.style.border = '2px solid #C62828'; btn.style.background = 'rgba(198,40,40,0.15)'; btn.style.color = '#C62828';
    }
    // Enable check button when all answered
    const total = (schemeData.eligibility_questions || []).length;
    document.getElementById('checkBtn').disabled = Object.keys(answers).length < total;
  }

  function checkEligibility() {
    const questions = schemeData.eligibility_questions || [];
    let matches = 0;
    questions.forEach((q, i) => {
      if (answers[i] === q.eligible_answer) matches++;
    });
    const total = questions.length;
    const pct = total > 0 ? (matches / total) * 100 : 0;
    const resultEl = document.getElementById('resultArea');
    resultEl.classList.remove('hidden');

    let color, icon, title, message;
    if (pct === 100) {
      color = 'rgba(46,125,50,0.12)'; icon = '‚úÖ'; title = 'You Appear Eligible!';
      message = `You matched all ${total} criteria. Here's how to apply:<br><br><strong>${escapeHtml(schemeData.how_to_apply)}</strong>`;
    } else if (pct >= 50) {
      color = 'rgba(255,152,0,0.12)'; icon = '‚ö†Ô∏è'; title = 'You May Be Partially Eligible';
      message = `You matched ${matches} out of ${total} criteria. You may still qualify ‚Äî we recommend contacting the ${deptLabel(schemeData.department)} department for clarification.`;
    } else {
      color = 'rgba(198,40,40,0.1)'; icon = '‚ùå'; title = 'You May Not Be Eligible';
      message = `You matched ${matches} out of ${total} criteria. This scheme may not be the right fit, but you can <a href="/schemes" class="auth-link">browse other schemes</a> or <a href="/chatbot" class="auth-link">ask the chatbot</a> for help.`;
    }

    resultEl.innerHTML = `
    <div class="glass-strong card card-animate" style="padding:2rem;text-align:center;background:${color};">
      <div style="font-size:2.5rem;margin-bottom:0.5rem;">${icon}</div>
      <h2>${title}</h2>
      <p style="margin-top:0.75rem;line-height:1.7;">${message}</p>
    </div>`;

    resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // --- Helpers ---
  function formatBytes(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  // ===================================================================
  // DOCUMENT VIEWER (PDF.js + Image)
  // ===================================================================
  let pdfDoc = null, scale = 1.0;

  async function openDocViewer(docId, filename, contentType) {
    const overlay = document.getElementById('docViewerOverlay');
    const title = document.getElementById('docViewerTitle');
    const content = document.getElementById('docViewerContent');
    const pdfControls = document.getElementById('pdfControls');
    const pdfContainer = document.getElementById('pdfContainer');
    const imgContainer = document.getElementById('imageContainer');
    const viewerImg = document.getElementById('viewerImage');
    const loader = document.getElementById('loadingSpinner');

    title.textContent = filename;
    title.title = filename;
    const url = `/attachments/${docId}`;

    // Reset state
    pdfDoc = null;
    pdfControls.classList.add('hidden');
    pdfContainer.classList.add('hidden');
    pdfContainer.innerHTML = ''; // Clear pages
    imgContainer.classList.add('hidden');
    loader.classList.remove('hidden');
    overlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    if (contentType === 'application/pdf') {
      try {
        const loadingTask = pdfjsLib.getDocument(url);
        pdfDoc = await loadingTask.promise;

        pdfControls.classList.remove('hidden');
        pdfContainer.classList.remove('hidden');
        loader.classList.add('hidden');

        // Initial seamless fit
        fitToWidth();
      } catch (e) {
        loader.classList.add('hidden');
        showToast('Error loading PDF: ' + e.message, 'error');
        console.error(e);
      }
    } else if (contentType && contentType.startsWith('image/')) {
      viewerImg.src = url;
      loader.classList.add('hidden');
      imgContainer.classList.remove('hidden');
    } else {
      loader.classList.add('hidden');
      content.innerHTML = `<div style="padding:2rem;text-align:center;color:#37474F;"><p>Preview not available for this file type.</p><a href="${url}" target="_blank" class="btn btn-primary btn-sm mt-1">Download</a></div>`;
    }
  }

  async function fitToWidth() {
    if (!pdfDoc) return;
    const container = document.getElementById('docViewerContent');
    const page = await pdfDoc.getPage(1);
    const viewport = page.getViewport({ scale: 1 });

    const availableWidth = container.clientWidth;

    scale = availableWidth / viewport.width;
    renderAllPages();
  }

  async function renderAllPages() {
    const container = document.getElementById('pdfContainer');
    container.innerHTML = '';

    // Update Zoom Label
    const pct = Math.round(scale * 100);
    document.getElementById('zoomLevel').textContent = pct + '%';

    for (let num = 1; num <= pdfDoc.numPages; num++) {
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: scale });

      const canvas = document.createElement('canvas');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      canvas.style.display = 'block';

      canvas.style.marginBottom = '20px';
      canvas.style.background = '#FFFFFF';
      canvas.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';

      container.appendChild(canvas);

      const ctx = canvas.getContext('2d');
      const renderContext = { canvasContext: ctx, viewport: viewport };
      // Render efficiently
      page.render(renderContext);
    }
  }

  function zoomPdf(delta) {
    if (!pdfDoc) return;
    const newScale = scale + delta;
    if (newScale >= 0.2 && newScale <= 5.0) {
      scale = newScale;
      renderAllPages();
    }
  }

  function closeDocViewer() {
    document.getElementById('docViewerOverlay').classList.add('hidden');
    document.body.style.overflow = '';
    document.getElementById('pdfContainer').innerHTML = ''; // Clear memory
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !document.getElementById('docViewerOverlay').classList.contains('hidden')) closeDocViewer();
  });
</script>
{% endblock %}