{% extends "base.html" %}
{% block title %}Admin Panel — PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content wide">

  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- SLA DEADLINE ALERTS                                                    -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <div class="flex-between mb-2">
    <div>
      <h1><span class="icon" style="font-size:28px;color:var(--warning);">warning</span> SLA Deadline Alerts</h1>
      <p class="subtitle">Unresolved grievances nearing or past their deadlines</p>
    </div>
    <button class="btn btn-secondary" onclick="loadAlerts()" id="refreshAlertsBtn"><span class="icon sm">refresh</span>
      Refresh</button>
  </div>

  <!-- Alert summary counters -->
  <div class="card-grid-4 mb-2 hidden" id="alertSummary">
    <div class="metric-card card-animate" id="summaryTotal">
      <div class="metric-icon amber"><span class="icon">notifications</span></div>
      <div class="metric-value" id="totalAlertCount">0</div>
      <div class="metric-label">Total Alerts</div>
    </div>
    <div class="metric-card card-animate" id="summaryBreached">
      <div class="metric-icon red"><span class="icon">error</span></div>
      <div class="metric-value" id="breachedCount">0</div>
      <div class="metric-label">SLA Breached</div>
    </div>
    <div class="metric-card card-animate" id="summaryCritical">
      <div class="metric-icon amber"><span class="icon">schedule</span></div>
      <div class="metric-value" id="criticalCount">0</div>
      <div class="metric-label">Critical (&lt;24h)</div>
    </div>
    <div class="metric-card card-animate" id="summaryWarning">
      <div class="metric-icon blue"><span class="icon">bolt</span></div>
      <div class="metric-value" id="warningCount">0</div>
      <div class="metric-label">Warning (&lt;48h)</div>
    </div>
  </div>

  <!-- Alert cards container -->
  <div id="alertCards" class="mb-3">
    <div class="card" style="padding:2rem;text-align:center;">
      <div class="spinner"><span></span><span></span><span></span></div>
      <p class="text-muted" style="margin-top:0.5rem;">Loading deadline alerts…</p>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <!-- USER MANAGEMENT (existing)                                             -->
  <!-- ═══════════════════════════════════════════════════════════════════════ -->
  <div class="flex-between mb-2" style="margin-top:1rem;">
    <div>
      <h1><span class="icon" style="font-size:28px;">admin_panel_settings</span> User Management</h1>
      <p class="subtitle">Create, edit, and manage system accounts</p>
    </div>
    <button class="btn btn-primary" onclick="showCreateForm()">+ Create User</button>
  </div>

  <!-- Create / Edit Form (hidden by default) -->
  <div id="userForm" class="card mb-2" style="padding:1.5rem;display:none;">
    <h3 id="formTitle">Create New User</h3>
    <input type="hidden" id="editUserId">
    <div class="form-row">
      <div class="form-group"><label>Full Name</label><input type="text" class="form-control" id="fFullName" required>
      </div>
      <div class="form-group"><label>Email</label><input type="email" class="form-control" id="fEmail" required></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Username</label><input type="text" class="form-control" id="fUsername" required
          minlength="3"></div>
      <div class="form-group"><label>Password</label><input type="password" class="form-control" id="fPassword"
          minlength="6" placeholder="Min 6 characters"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Phone</label><input type="text" class="form-control" id="fPhone"
          placeholder="Optional"></div>
      <div class="form-group">
        <label>Role</label>
        <select class="form-control" id="fRole" onchange="toggleFormDept()">
          <option value="citizen">Citizen</option>
          <option value="officer">Officer</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="form-group" id="fDeptGroup" style="display:none;">
      <label>Department</label>
      <select class="form-control" id="fDepartment"></select>
    </div>
    <div style="display:flex;gap:0.5rem;margin-top:1rem;">
      <button class="btn btn-primary" onclick="submitUser()">Save</button>
      <button class="btn btn-secondary" onclick="hideForm()">Cancel</button>
    </div>
  </div>

  <!-- Role filter tabs -->
  <div class="card mb-2" style="padding:0.75rem 1rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
    <button class="btn btn-sm filter-tab active" data-role="" onclick="filterRole(this, '')">All</button>
    <button class="btn btn-sm filter-tab" data-role="citizen" onclick="filterRole(this, 'citizen')">Citizens</button>
    <button class="btn btn-sm filter-tab" data-role="officer" onclick="filterRole(this, 'officer')">Officers</button>
    <button class="btn btn-sm filter-tab" data-role="admin" onclick="filterRole(this, 'admin')">Admins</button>
    <span id="userCount" style="margin-left:auto;align-self:center;opacity:0.7;font-size:0.9rem;"></span>
  </div>

  <!-- User table -->
  <div class="card mb-3" style="padding:1rem;overflow:auto;max-height:520px;">
    <table style="width:100%;border-collapse:collapse;" id="userTable">
      <thead style="position:sticky;top:0;background:var(--surface-container-low);z-index:1;">
        <tr style="text-align:left;border-bottom:2px solid var(--outline-variant);">
          <th style="padding:0.65rem;">Name</th>
          <th style="padding:0.65rem;">Username</th>
          <th style="padding:0.65rem;">Email</th>
          <th style="padding:0.65rem;">Role</th>
          <th style="padding:0.65rem;">Department</th>
          <th style="padding:0.65rem;">Created</th>
          <th style="padding:0.65rem;text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="userTableBody">
        <tr>
          <td colspan="7" style="padding:2rem;text-align:center;">
            <div class="spinner"><span></span><span></span><span></span></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Spam Flagged Users Section -->
  <div class="card mb-3" style="padding:1.25rem;" id="spamSection">
    <h3 style="margin:0 0 0.75rem;"><span class="icon" style="font-size:18px;color:var(--error);">block</span> Spam
      Flagged Users</h3>
    <div id="spamList">
      <div class="text-sm text-muted">Loading...</div>
    </div>
  </div>

  <!-- Officer Anomalies Section -->
  <div class="card mb-3" style="padding:1.25rem;" id="anomalySection">
    <h3 style="margin:0 0 0.75rem;"><span class="icon" style="font-size:18px;">policy</span> Officer Accountability
      Flags</h3>
    <div id="anomalyList">
      <div class="text-sm text-muted">Loading...</div>
    </div>
  </div>

  <!-- Forecast Generation -->
  <div class="card mb-3" style="padding:1.25rem;">
    <h3 style="margin:0 0 0.75rem;"><span class="icon" style="font-size:18px;">analytics</span> Predictive Forecast</h3>
    <p class="text-sm text-muted">Generate a 2-week grievance spike forecast based on historical data and weather
      patterns.</p>
    <button class="btn btn-primary btn-sm" id="genForecastBtn" onclick="generateForecast()">Generate Forecast</button>
    <span id="forecastStatus" class="text-sm" style="margin-left:0.5rem;"></span>
  </div>
</div>
{% endblock %}
{% block scripts %}
<style>
  /* Admin-specific styles are now in the main stylesheet.
     Only page-specific overrides here. */
  #userTable tbody tr {
    border-bottom: 1px solid var(--surface-container);
    transition: background 0.15s;
  }

  #userTable tbody tr:hover {
    background: var(--surface-container-low);
  }

  .alert-countdown.overdue {
    color: var(--error);
  }

  .alert-countdown.critical {
    color: var(--warning);
  }

  .alert-countdown.warning {
    color: #F9A825;
  }

  .alert-section-label.breached {
    color: var(--error);
  }

  .alert-section-label.critical {
    color: var(--warning);
  }

  .alert-section-label.warning {
    color: #F9A825;
  }
</style>
<script>
  /* ═══════════════════════════════════════════════════════════════════════════
     SLA DEADLINE ALERTS
     ═══════════════════════════════════════════════════════════════════════════ */
  async function loadAlerts() {
    const container = document.getElementById('alertCards');
    const summary = document.getElementById('alertSummary');
    container.innerHTML = '<div class="card" style="padding:2rem;text-align:center;"><div class="spinner"><span></span><span></span><span></span></div><p class="text-muted" style="margin-top:0.5rem;">Loading deadline alerts…</p></div>';
    summary.classList.add('hidden');

    try {
      const data = await api('GET', '/admin/deadline-alerts');
      // Update summary counters
      document.getElementById('totalAlertCount').textContent = data.total_alerts;
      document.getElementById('breachedCount').textContent = data.breached.length;
      document.getElementById('criticalCount').textContent = data.critical.length;
      document.getElementById('warningCount').textContent = data.warning.length;
      summary.style.display = 'grid';

      if (data.total_alerts === 0) {
        container.innerHTML = '<div class="card all-clear"><span class="icon filled" style="font-size:2.5rem;color:var(--success);">check_circle</span><br>All clear — no grievances nearing their SLA deadline.</div>';
        return;
      }

      let html = '';
      if (data.breached.length) {
        html += '<div class="alert-section-label breached"><span class="icon sm" style="color:var(--error);">error</span> SLA Breached (' + data.breached.length + ')</div>';
        html += data.breached.map(g => alertCard(g, 'breached')).join('');
      }
      if (data.critical.length) {
        html += '<div class="alert-section-label critical"><span class="icon sm" style="color:var(--warning);">schedule</span> Critical — Less than 24 hours (' + data.critical.length + ')</div>';
        html += data.critical.map(g => alertCard(g, 'critical')).join('');
      }
      if (data.warning.length) {
        html += '<div class="alert-section-label warning"><span class="icon sm" style="color:#F9A825;">bolt</span> Warning — Less than 48 hours (' + data.warning.length + ')</div>';
        html += data.warning.map(g => alertCard(g, 'warning')).join('');
      }
      container.innerHTML = html;

      // Bind click handlers
      container.querySelectorAll('.alert-card').forEach(card => {
        card.addEventListener('click', () => {
          window.location.href = '/grievance-detail?id=' + card.dataset.id;
        });
      });
    } catch (e) {
      container.innerHTML = '<div class="card" style="padding:1.5rem;text-align:center;color:var(--error);"><span class="icon">error</span> Failed to load alerts: ' + escapeHtml(e.message) + '</div>';
    }
  }

  function alertCard(g, severity) {
    const icons = { breached: '<span class="icon filled" style="color:var(--error);">error</span>', critical: '<span class="icon" style="color:var(--warning);">schedule</span>', warning: '<span class="icon" style="color:#F9A825;">bolt</span>' };
    const countdownText = getCountdownText(g.sla_deadline, severity);
    return `
    <div class="alert-card alert-${severity}" data-id="${escapeHtml(g.id)}">
      <div class="alert-severity-icon">${icons[severity]}</div>
      <div class="alert-body">
        <div class="alert-title">${escapeHtml(g.title)}</div>
        <div class="alert-meta">
          <span style="font-family:monospace;">${escapeHtml(g.tracking_number)}</span>
          ${deptBadge(g.department)}
          ${priorityBadge(g.priority)}
          ${statusBadge(g.status)}
        </div>
      </div>
      <div class="alert-countdown ${severity}">${countdownText}</div>
    </div>`;
  }

  function getCountdownText(isoDeadline, severity) {
    if (!isoDeadline) return '';
    const now = new Date();
    const deadline = new Date(isoDeadline);
    const diffMs = deadline - now;

    if (diffMs <= 0) {
      // Overdue
      const overMs = Math.abs(diffMs);
      const overH = Math.floor(overMs / 3600000);
      const overD = Math.floor(overH / 24);
      if (overD > 0) return `${overD}d ${overH % 24}h overdue`;
      return `${overH}h overdue`;
    }
    const h = Math.floor(diffMs / 3600000);
    const m = Math.floor((diffMs % 3600000) / 60000);
    if (h > 0) return `${h}h ${m}m left`;
    return `${m}m left`;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     USER MANAGEMENT (existing code preserved)
     ═══════════════════════════════════════════════════════════════════════════ */
  let allUsers = [];
  let spamStatusMap = {};
  let currentFilter = '';

  if (requireAuth()) {
    const u = getUser();
    if (u.role !== 'admin') { window.location.href = '/officer-dashboard'; }
    else {
      loadAlerts();
      loadUsers();
      loadSpamFlagged();
      loadOfficerAnomalies();
    }
  }

  async function loadSpamFlagged() {
    try {
      const records = await api('GET', '/admin/spam-flagged');
      const el = document.getElementById('spamList');
      spamStatusMap = {};
      records.forEach(r => { spamStatusMap[r.user_id] = r; });
      if (allUsers.length) renderTable();
      if (!records.length) { el.innerHTML = '<div class="text-sm text-muted">No spam-flagged users.</div>'; return; }
      el.innerHTML = records.map(r => `
      <div class="card" style="padding:0.75rem;margin-bottom:0.5rem;border-left:4px solid var(--error);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>${escapeHtml(r.full_name)} (@${escapeHtml(r.username)})</strong>
          <span class="text-sm">Spam score: ${(r.spam_score * 100).toFixed(0)}%</span>
        </div>
        <div class="text-sm" style="margin:0.3rem 0;">
          Photo ID: <strong>${escapeHtml(r.photo_id_status)}</strong>
          ${r.photo_id_file_id ? ` · <a href="/attachments/${r.photo_id_file_id}" target="_blank">View Photo ID</a>` : ''}
        </div>
        ${r.pattern_flags.length ? '<div class="text-sm text-muted">Flags: ' + r.pattern_flags.map(f => escapeHtml(f.type + ': ' + f.detail)).join(', ') + '</div>' : ''}
        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;align-items:center;">
          <button class="btn btn-success btn-sm spam-approve-btn" data-uid="${escapeHtml(r.user_id)}"><span class="icon sm">check</span> Approve & Unblock</button>
          <button class="btn btn-secondary btn-sm spam-reject-btn" data-uid="${escapeHtml(r.user_id)}"><span class="icon sm">close</span> Reject ID</button>
          <a href="/spam-flag-detail?id=${encodeURIComponent(r.user_id)}" class="btn btn-sm" style="margin-left:auto;"><span class="icon sm">open_in_new</span> View Details</a>
        </div>
      </div>`).join('');
      document.querySelectorAll('.spam-approve-btn').forEach(b => b.addEventListener('click', () => reviewSpam(b.dataset.uid, true)));
      document.querySelectorAll('.spam-reject-btn').forEach(b => b.addEventListener('click', () => reviewSpam(b.dataset.uid, false)));
    } catch { document.getElementById('spamList').innerHTML = '<div class="text-sm text-muted">Failed to load.</div>'; }
  }

  async function reviewSpam(uid, approved) {
    try { await api('PUT', `/admin/spam-flagged/${uid}/review?approved=${approved}`); showToast(approved ? 'User unblocked' : 'Photo ID rejected'); loadSpamFlagged(); } catch (e) { showToast(e.message, 'error'); }
  }

  async function loadOfficerAnomalies() {
    try {
      const records = await api('GET', '/admin/officer-anomalies');
      const el = document.getElementById('anomalyList');
      if (!records.length) { el.innerHTML = '<div class="text-sm text-muted">No anomalies detected.</div>'; return; }
      el.innerHTML = records.map(r => `
      <div class="card" style="padding:0.75rem;margin-bottom:0.5rem;border-left:4px solid var(--warning);">
        <strong>${escapeHtml(r.full_name)} (@${escapeHtml(r.username)})</strong>
        <div style="margin-top:0.3rem;">
          ${r.anomaly_flags.map(f => `
            <div class="text-sm" style="margin:0.2rem 0;padding:0.3rem 0.5rem;background:var(--warning-container);border-radius:var(--radius-xs);display:flex;justify-content:space-between;align-items:center;">
              <span><strong>${escapeHtml(f.type)}:</strong> ${escapeHtml(f.detail)} <span class="badge badge-priority-${escapeHtml(f.severity || 'medium')}">${escapeHtml(f.severity || 'medium')}</span></span>
              <button class="btn btn-secondary btn-sm dismiss-flag-btn" data-oid="${escapeHtml(r.officer_id)}" data-fid="${escapeHtml(f.id)}" style="font-size:0.7rem;">Dismiss</button>
            </div>`).join('')}
        </div>
      </div>`).join('');
      document.querySelectorAll('.dismiss-flag-btn').forEach(b => b.addEventListener('click', () => dismissFlag(b.dataset.oid, b.dataset.fid)));
    } catch { document.getElementById('anomalyList').innerHTML = '<div class="text-sm text-muted">Failed to load.</div>'; }
  }

  async function dismissFlag(oid, fid) {
    try { await api('PUT', `/admin/officer-anomalies/${oid}/dismiss/${fid}`); showToast('Flag dismissed'); loadOfficerAnomalies(); } catch (e) { showToast(e.message, 'error'); }
  }

  async function generateForecast() {
    const btn = document.getElementById('genForecastBtn');
    const status = document.getElementById('forecastStatus');
    btn.disabled = true; status.textContent = 'Generating...';
    try { await api('POST', '/forecasts/generate'); status.textContent = 'Forecast generated!'; showToast('Forecast generated successfully'); } catch (e) { status.textContent = 'Failed'; showToast(e.message, 'error'); }
    btn.disabled = false;
  }

  async function loadUsers() {
    try {
      const url = currentFilter ? `/admin/users?role=${currentFilter}` : '/admin/users';
      allUsers = await api('GET', url);
      renderTable();
    } catch (e) { showToast(e.message, 'error'); }
  }

  const ADMIN_USER_PAGE_SIZE = 25;
  let adminShowAll = false;

  function renderTable() {
    const tbody = document.getElementById('userTableBody');
    document.getElementById('userCount').textContent = `${allUsers.length} user${allUsers.length !== 1 ? 's' : ''}`;
    if (!allUsers.length) {
      tbody.innerHTML = '<tr><td colspan="7" style="padding:2rem;text-align:center;opacity:0.6;">No users found</td></tr>';
      return;
    }
    const displayUsers = adminShowAll ? allUsers : allUsers.slice(0, ADMIN_USER_PAGE_SIZE);
    tbody.innerHTML = displayUsers.map(u => {
      const isBlocked = u.role === 'citizen' && spamStatusMap[u.id];
      const blockBtns = u.role === 'citizen' ? (isBlocked
        ? `<a href="/spam-flag-detail?id=${encodeURIComponent(u.id)}" class="action-btn" title="View Flag Details" style="color:var(--error);"><span class="icon sm">gpp_bad</span> Flag</a>`
          + `<button class="action-btn user-unblock-btn" data-id="${escapeHtml(u.id)}" title="Unblock" style="color:var(--success);"><span class="icon sm">lock_open</span> Unblock</button>`
        : `<button class="action-btn user-block-btn" data-id="${escapeHtml(u.id)}" data-username="${escapeHtml(u.username)}" title="Block"><span class="icon sm">block</span> Block</button>`
          + `<button class="action-btn user-flag-btn" data-id="${escapeHtml(u.id)}" data-username="${escapeHtml(u.username)}" title="Require Photo ID" style="color:var(--warning);"><span class="icon sm">flag</span> Flag</button>`
      ) : '';
      const blockedBadge = isBlocked ? ` <a href="/spam-flag-detail?id=${encodeURIComponent(u.id)}" class="badge badge-escalated" style="font-size:0.65rem;text-decoration:none;cursor:pointer;" title="View flag details">Blocked</a>` : '';
      return `
    <tr${isBlocked ? ' style="background:var(--error-container);"' : ''}>
      <td style="padding:0.65rem;font-weight:500;">${escapeHtml(u.full_name)}${blockedBadge}</td>
      <td style="padding:0.65rem;font-family:monospace;font-size:0.9rem;">${escapeHtml(u.username)}</td>
      <td style="padding:0.65rem;">${escapeHtml(u.email)}</td>
      <td style="padding:0.65rem;"><span class="role-badge role-${escapeHtml(u.role)}">${escapeHtml(u.role)}</span></td>
      <td style="padding:0.65rem;">${u.department ? deptLabel(u.department) : '<span style="opacity:0.4;">—</span>'}</td>
      <td style="padding:0.65rem;font-size:0.9rem;">${formatDate(u.created_at)}</td>
      <td style="padding:0.65rem;text-align:right;white-space:nowrap;">
        ${blockBtns}
        <button class="action-btn user-edit-btn" data-id="${escapeHtml(u.id)}" title="Edit" aria-label="Edit user ${escapeHtml(u.username)}"><span class="icon sm">edit</span> Edit</button>
        <button class="action-btn danger user-del-btn" data-id="${escapeHtml(u.id)}" data-username="${escapeHtml(u.username)}" title="Delete" aria-label="Delete user ${escapeHtml(u.username)}"><span class="icon sm">delete</span> Delete</button>
      </td>
    </tr>`;
    }).join('');
    document.querySelectorAll('.user-edit-btn').forEach(btn => {
      btn.addEventListener('click', () => editUser(btn.dataset.id));
    });
    document.querySelectorAll('.user-del-btn').forEach(btn => {
      btn.addEventListener('click', () => deleteUser(btn.dataset.id, btn.dataset.username));
    });
    document.querySelectorAll('.user-block-btn').forEach(btn => {
      btn.addEventListener('click', () => adminBlockUser(btn.dataset.id, btn.dataset.username, 'block'));
    });
    document.querySelectorAll('.user-unblock-btn').forEach(btn => {
      btn.addEventListener('click', () => adminBlockUser(btn.dataset.id, '', 'unblock'));
    });
    document.querySelectorAll('.user-flag-btn').forEach(btn => {
      btn.addEventListener('click', () => adminBlockUser(btn.dataset.id, btn.dataset.username, 'flag_spam'));
    });
    // Show All / Show Less toggle if there are more users than the page size
    const oldToggle = document.getElementById('adminUserToggle');
    if (oldToggle) oldToggle.remove();
    if (allUsers.length > ADMIN_USER_PAGE_SIZE) {
      const wrap = document.createElement('div');
      wrap.id = 'adminUserToggle';
      wrap.className = 'load-more-wrap';
      wrap.innerHTML = adminShowAll
        ? `<button class="btn btn-secondary btn-sm" onclick="adminShowAll=false;renderTable()"><span class="icon sm">expand_less</span> Show Less</button>`
        : `<button class="btn btn-secondary btn-sm" onclick="adminShowAll=true;renderTable()"><span class="icon sm">expand_more</span> Show All ${allUsers.length} Users</button>`;
      tbody.parentElement.parentElement.appendChild(wrap);
    }
  }

  function filterRole(btn, role) {
    document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = role;
    loadUsers();
  }

  // --- Form ---
  document.getElementById('fDepartment').innerHTML = deptOptions();

  function toggleFormDept() {
    const role = document.getElementById('fRole').value;
    document.getElementById('fDeptGroup').style.display = (role === 'officer') ? 'block' : 'none';
  }

  function showCreateForm() {
    document.getElementById('formTitle').textContent = 'Create New User';
    document.getElementById('editUserId').value = '';
    document.getElementById('fFullName').value = '';
    document.getElementById('fEmail').value = '';
    document.getElementById('fUsername').value = '';
    document.getElementById('fUsername').disabled = false;
    document.getElementById('fPassword').value = '';
    document.getElementById('fPassword').placeholder = 'Min 6 characters';
    document.getElementById('fPassword').required = true;
    document.getElementById('fPhone').value = '';
    document.getElementById('fRole').value = 'officer';
    toggleFormDept();
    document.getElementById('userForm').style.display = 'block';
    document.getElementById('fFullName').focus();
  }

  function editUser(id) {
    const u = allUsers.find(x => x.id === id);
    if (!u) return;
    document.getElementById('formTitle').textContent = `Edit: ${u.full_name}`;
    document.getElementById('editUserId').value = u.id;
    document.getElementById('fFullName').value = u.full_name;
    document.getElementById('fEmail').value = u.email;
    document.getElementById('fUsername').value = u.username;
    document.getElementById('fUsername').disabled = true;
    document.getElementById('fPassword').value = '';
    document.getElementById('fPassword').placeholder = 'Leave blank to keep current';
    document.getElementById('fPassword').required = false;
    document.getElementById('fPhone').value = u.phone || '';
    document.getElementById('fRole').value = u.role;
    document.getElementById('fDepartment').innerHTML = deptOptions(u.department);
    toggleFormDept();
    document.getElementById('userForm').style.display = 'block';
    document.getElementById('fFullName').focus();
  }

  function hideForm() {
    document.getElementById('userForm').style.display = 'none';
  }

  async function submitUser() {
    const editId = document.getElementById('editUserId').value;
    const role = document.getElementById('fRole').value;
    const password = document.getElementById('fPassword').value;

    if (!editId && (!password || password.length < 6)) {
      showToast('Password is required (min 6 characters)', 'error'); return;
    }

    try {
      if (editId) {
        // Update
        const body = {
          full_name: document.getElementById('fFullName').value,
          email: document.getElementById('fEmail').value,
          phone: document.getElementById('fPhone').value || null,
          role: role,
        };
        if (role === 'officer') body.department = document.getElementById('fDepartment').value;
        if (password) body.password = password;
        await api('PUT', `/admin/users/${editId}`, body);
        showToast('User updated');
      } else {
        // Create
        const body = {
          full_name: document.getElementById('fFullName').value,
          email: document.getElementById('fEmail').value,
          phone: document.getElementById('fPhone').value || null,
          username: document.getElementById('fUsername').value,
          password: password,
          role: role,
        };
        if (role === 'officer') body.department = document.getElementById('fDepartment').value;
        await api('POST', '/admin/users', body);
        showToast('User created');
      }
      hideForm();
      loadUsers();
    } catch (e) {
      showToast(e.message, 'error');
    }
  }

  async function adminBlockUser(id, username, action) {
    const labels = {
      block: `Block user "${username}"? They will be unable to file grievances until unblocked.`,
      unblock: 'Unblock this user? Their spam flags will be cleared.',
      flag_spam: `Flag "${username}" as spam? They will be forced to upload a photo ID to continue.`,
    };
    if (!confirm(labels[action])) return;
    let reason = 'Manual admin action';
    if (action !== 'unblock') {
      const input = prompt('Reason (optional):', reason);
      if (input === null) return;
      reason = input || reason;
    }
    try {
      await api('PUT', `/admin/users/${id}/block?action=${action}&reason=${encodeURIComponent(reason)}`);
      const msgs = { block: 'User blocked', unblock: 'User unblocked', flag_spam: 'User flagged — must upload photo ID' };
      showToast(msgs[action]);
      loadSpamFlagged();
      loadUsers();
    } catch (e) { showToast(e.message, 'error'); }
  }

  async function deleteUser(id, username) {
    if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
    try {
      await api('DELETE', `/admin/users/${id}`);
      showToast('User deleted');
      loadUsers();
    } catch (e) { showToast(e.message, 'error'); }
  }
</script>
{% endblock %}