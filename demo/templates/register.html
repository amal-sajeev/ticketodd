{% extends "base.html" %}
{% block title %}Register â€” PR&DW Portal{% endblock %}

{% block head %}
<!-- Allow camera access in this page -->
<meta http-equiv="Permissions-Policy" content="camera=*">
{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/auth-v2.css">

<div class="auth-page-container">
  <div class="auth-split-layout">
    <!-- Left Panel: Branding -->
    <div class="auth-left-panel">
      <div class="auth-brand">
        <div class="auth-logo">
          <img src="/static/image.jpg" alt="Government of Odisha" class="auth-logo-img">
        </div>
        <h2>Government of Odisha</h2>
        <p>Panchayati Raj & Drinking Water Department</p>
      </div>

      <div class="auth-features">
        <ul class="auth-feature-list">
          <li class="auth-feature-item">
            <span class="icon">how_to_reg</span>
            <span>Easy Citizen Registration</span>
          </li>
          <li class="auth-feature-item">
            <span class="icon">track_changes</span>
            <span>Real-time Application Tracking</span>
          </li>
          <li class="auth-feature-item">
            <span class="icon">notifications</span>
            <span>SMS & Email Alerts</span>
          </li>
        </ul>
        <div class="auth-footer-link">
          Â© 2026 Government of Odisha
        </div>
      </div>
    </div>

    <!-- Right Panel: Register Form -->
    <div class="auth-right-panel">

      <!-- Step 1: Basic Info -->
      <div id="step1" class="step-container active">
        <div class="auth-header">
          <h3>Create Account</h3>
          <p>Enter your details to register</p>
        </div>
        <form onsubmit="event.preventDefault(); nextStep();">
          <div class="form-group"><label>Full Name</label><input type="text" class="form-control" id="fullName" required
              placeholder="e.g. Rahul Das"></div>
          <div class="form-row" style="display:flex;gap:1rem;">
            <div class="form-group" style="flex:1;"><label>Email</label><input type="email" class="form-control"
                id="email" required placeholder="name@example.com"></div>
            <div class="form-group" style="flex:1;"><label>Phone</label><input type="text" class="form-control"
                id="phone" placeholder="Mobile Number"></div>
          </div>
          <div class="form-row" style="display:flex;gap:1rem;">
            <div class="form-group" style="flex:1;"><label>Username</label><input type="text" class="form-control"
                id="username" required minlength="3" placeholder="Choose username"></div>
            <div class="form-group" style="flex:1;"><label>Password</label><input type="password" class="form-control"
                id="password" required minlength="6" placeholder="Create password"></div>
          </div>
          <div id="regError" class="text-sm"
            style="color:#ff8a80;margin-bottom:1rem;display:none;background:rgba(255,0,0,0.1);padding:0.5rem;border-radius:8px;border:1px solid rgba(255,0,0,0.3);">
          </div>
          <button type="submit" class="btn btn-primary btn-block">Next: Face Setup</button>

          <div style="margin-top:1.5rem;text-align:center;font-size:0.9rem;">
            <span style="color:rgba(20, 19, 19, 0.7);">Already have an account?</span> <a href="/login"
              style="color:#00c6ff;font-weight:600;text-decoration:none;">Sign In</a>
          </div>
        </form>
      </div>

      <!-- Step 2: Face Enrollment -->
      <div id="step2" class="step-container">
        <div class="auth-header" style="margin-bottom:1rem;">
          <h3>Face Enrollment</h3>
          <p>Secure your account with biometrics</p>
        </div>

        <div class="video-container active" id="videoBox"
          style="position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:12px;overflow:hidden;margin-bottom:1rem;">
          <video id="video" autoplay muted playsinline
            style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1);"></video>
          <canvas id="canvas"
            style="position:absolute;top:0;left:0;width:100%;height:100%;transform:scaleX(-1);"></canvas>
        </div>

        <p class="text-center text-sm mb-3" id="faceStatus" style="font-weight:500;">
          Initializing...</p>

        <button class="btn btn-secondary btn-block mb-2" id="captureBtn" onclick="captureFace()" disabled>Capture
          Face</button>

        <button class="btn btn-link btn-block mb-2" id="skipBtn" onclick="handleRegister()">Skip for now</button>

        <div id="step2Error" class="text-sm text-center"
          style="color:#ff8a80;margin-bottom:1rem;display:none;background:rgba(255,0,0,0.1);padding:0.5rem;border-radius:8px;border:1px solid rgba(255,0,0,0.3);">
        </div>

        <button class="btn btn-primary btn-block" id="finishBtn" onclick="handleRegister()" style="display:none;">Finish
          & Register</button>

        <button class="btn btn-link btn-block btn-sm" onclick="location.reload()"
          style="margin-top:0.5rem;background:none;border:none;cursor:pointer;">Back</button>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}

<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
  let stream = null;
  let currentStep = 1;
  let faceDescriptor = null;
  let faceModelsLoaded = false;

  async function nextStep() {
    // Validate Step 1
    if (!document.getElementById('fullName').value || !document.getElementById('email').value ||
      !document.getElementById('username').value || !document.getElementById('password').value) {
      showError("Please fill all required fields");
      return;
    }

    hideError();
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step2').classList.add('active');
    currentStep = 2;

    await startCamera();
  }

  async function startCamera() {
    const statusEl = document.getElementById('faceStatus');

    // Check if running on secure context
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      showError("Camera requires HTTPS. Please access via https:// or use localhost.");
      return;
    }

    // Check permissions policy
    if (document.featurePolicy && !document.featurePolicy.allowsFeature('camera')) {
      console.error("âŒ Camera blocked by permissions policy");
      showError("Camera is blocked by page security policy. Please check server configuration.");
      return;
    }

    statusEl.textContent = "Loading models...";
    console.log("ðŸ“¦ Loading face detection models...");

    if (!faceModelsLoaded) {
      try {
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        faceModelsLoaded = true;
        console.log("âœ… Face detection models loaded");
      } catch (e) {
        console.error("âŒ Model loading error:", e);
        showError("Failed to load AI models");
        return;
      }
    }

    statusEl.textContent = "Starting camera...";
    console.log("ðŸ“· Requesting camera access...");
    console.log("Protocol:", location.protocol, "Hostname:", location.hostname);

    try {
      // Check if camera API is available
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('Camera not supported in this browser');
      }

      const video = document.getElementById('video');

      // Request camera permission with better error handling
      try {
        console.log("Attempting camera access with ideal constraints...");
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          }
        });
        console.log("âœ… Camera access granted!");
      } catch (err) {
        // Fallback to simpler constraints
        console.warn("âš ï¸ Ideal constraints failed, trying fallback...");
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' }
        });
        console.log("âœ… Camera access granted (fallback)!");
      }

      video.srcObject = stream;

      video.addEventListener('play', () => {
        const canvas = document.getElementById('canvas');

        // Wait for video dimensions
        const checkVideo = setInterval(() => {
          if (video.videoWidth > 0 && video.videoHeight > 0) {
            clearInterval(checkVideo);
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            statusEl.textContent = "Position your face...";
            console.log("ðŸ‘ï¸ Starting face detection...");

            startDetectionLoop(video, canvas, displaySize, statusEl);
          }
        }, 100);
      });
    } catch (err) {
      console.error("âŒ Camera error:", err);
      stopCamera();

      // More specific error messages
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        showError("Camera permission denied. Please:\n1. Click the camera icon in your browser's address bar\n2. Allow camera access\n3. Refresh and try again");
      } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
        showError("No camera found. Please connect a camera and try again.");
      } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
        showError("Camera is in use by another application. Please close other apps and try again.");
      } else if (err.name === 'OverconstrainedError') {
        showError("Camera doesn't support the required settings. Try a different camera.");
      } else if (err.name === 'SecurityError') {
        showError("Camera access blocked due to security settings. Please use HTTPS or localhost.");
      } else {
        showError("Camera error: " + (err.message || 'Unable to access camera. Please check your browser settings.'));
      }
    }
  }

  function startDetectionLoop(video, canvas, displaySize, statusEl) {
    setInterval(async () => {
      if (currentStep !== 2 || faceDescriptor) return;

      const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (detections) {
        const resizedDetections = faceapi.resizeResults(detections, displaySize);
        faceapi.draw.drawDetections(canvas, resizedDetections);
        statusEl.textContent = "Face detected! Click 'Capture' to save.";
        statusEl.style.color = "#2E7D32";
        document.getElementById('captureBtn').disabled = false;
        // Store temporarily
        window.lastDescriptor = detections.descriptor;
      } else {
        statusEl.textContent = "Looking for face...";
        statusEl.style.color = "#666";
        document.getElementById('captureBtn').disabled = true;
      }
    }, 500);
  }

  function captureFace() {
    if (window.lastDescriptor) {
      faceDescriptor = Array.from(window.lastDescriptor);
      const statusEl = document.getElementById('faceStatus');
      statusEl.textContent = "âœ… Face captured successfully!";
      statusEl.style.color = "#2E7D32";

      // Freeze the image by drawing video frame to canvas
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      // Ensure canvas size matches video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      // Draw video frame (mirrored if video is mirrored by CSS)
      ctx.save();
      ctx.scale(-1, 1);
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();

      document.getElementById('captureBtn').style.display = 'none';
      document.getElementById('skipBtn').style.display = 'none';
      document.getElementById('finishBtn').style.display = 'block';

      console.log("âœ… Face descriptor captured:", faceDescriptor.length, "dimensions");

      // Hide video and show canvas with captured frame
      video.style.display = 'none';
      canvas.style.position = 'relative';
      canvas.style.display = 'block';

      // Stop camera to save resources
      stopCamera();
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      console.log("ðŸ”´ Camera stopped");
    }
    // Also clear video srcObject
    const video = document.getElementById('video');
    if (video) {
      video.srcObject = null;
    }
  }

  async function handleRegister() {
    const btn = document.getElementById('finishBtn');
    btn.disabled = true;
    btn.textContent = "Creating Account...";

    const body = {
      full_name: document.getElementById('fullName').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value || null,
      username: document.getElementById('username').value,
      password: document.getElementById('password').value,
      role: 'citizen',
      face_descriptor: faceDescriptor
    };

    console.log("ðŸ“¤ Sending registration request...");

    try {
      const data = await api('POST', '/auth/register', body);
      console.log("âœ… Registration successful!");
      setAuth(data.access_token, data.user);
      window.location.href = '/dashboard';
    } catch (err) {
      console.error("âŒ Registration failed:", err);
      showError(err.message || 'Registration failed');
      btn.disabled = false;
      btn.textContent = "Finish & Register";
    }
  }

  function showError(msg) {
    if (currentStep === 1) {
      const el = document.getElementById('regError');
      el.textContent = msg;
      el.style.display = 'block';
    } else {
      const el = document.getElementById('step2Error');
      el.textContent = msg;
      el.style.display = 'block';
    }
  }

  function hideError() {
    document.getElementById('regError').style.display = 'none';
    document.getElementById('step2Error').style.display = 'none';
  }

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    stopCamera();
  });
</script>
{% endblock %}