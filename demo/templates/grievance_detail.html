{% extends "base.html" %}
{% block title %}Grievance Detail — PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content wide">
  <a id="backLink" href="/queue" class="btn btn-secondary btn-sm mb-2">← Back to Queue</a>
  <div id="detailContent"><div class="spinner"><span></span><span></span><span></span></div></div>
</div>
{% endblock %}
{% block scripts %}
<style>
.deadline-badge { display:inline-block;padding:0.2rem 0.6rem;border-radius:8px;font-size:0.82rem;font-weight:600; }
.deadline-green { background:var(--success-container);color:var(--success); }
.deadline-yellow { background:var(--primary-container-low);color:#E65100; }
.deadline-red { background:var(--error-container);color:var(--error); }
.deadline-breached { background:var(--error-container);color:var(--error);animation:pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.5;} }
.impact-circle { display:inline-flex;align-items:center;justify-content:center;width:48px;height:48px;border-radius:50%;font-weight:700;font-size:1.1rem;color:#fff; }
.attachment-grid { display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:0.5rem; }
.attachment-item { background:var(--primary-container-low);border-radius:10px;padding:0.5rem;text-align:center;max-width:160px; }
.attachment-item img { max-width:140px;max-height:100px;border-radius:6px; }
.sub-task-card { background:var(--primary-container-low);border-radius:10px;padding:0.75rem;margin-bottom:0.5rem;border-left:4px solid var(--primary); }
.sub-task-card.resolved { border-left-color:#66BB6A;opacity:0.7; }
.scheme-match-card { background:var(--success-container);border:1px solid rgba(76,175,80,0.25);border-radius:12px;padding:1rem;margin-top:1rem; }
.vouch-section { margin-top:1.5rem; }
.vouch-item { display:flex;gap:0.6rem;padding:0.6rem 0;border-bottom:1px solid var(--surface-container); }
.vouch-item:last-child { border-bottom:none; }
.vouch-avatar { width:36px;height:36px;border-radius:50%;background:var(--primary-container-low);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.8rem;font-weight:700;color:var(--primary); }
.vouch-item-body { flex:1;min-width:0; }
.vouch-item-name { font-weight:600;font-size:0.85rem; }
.vouch-item-date { font-size:0.75rem;color:var(--on-surface-variant);margin-left:0.5rem; }
.vouch-item-comment { font-size:0.88rem;color:var(--on-surface-variant);margin-top:0.2rem;line-height:1.5; }
.vouch-evidence-grid { display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:0.4rem; }
.vouch-evidence-grid img { width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid var(--outline-variant);transition:transform 0.15s; }
.vouch-evidence-grid img:hover { transform:scale(1.05); }
.vouch-evidence-grid video, .vouch-evidence-grid audio { max-width:160px;border-radius:8px; }
</style>
<script>
let officersList = [];
const user = getUser();
const isCitizen = user && user.role === 'citizen';

if (requireAuth()) {
  if (isCitizen) {
    const bl = document.getElementById('backLink');
    bl.href = '/dashboard';
    bl.textContent = '\u2190 Back to Dashboard';
  }
  loadDetail();
}

function deadlineBadge(deadline, label) {
  if (!deadline) return '';
  const now = new Date();
  const dl = new Date(deadline);
  const remaining = dl - now;
  const total = dl - new Date(dl.getTime() - 7 * 24 * 3600000);
  const ratio = remaining / total;
  let cls = 'deadline-green';
  if (remaining <= 0) cls = 'deadline-breached';
  else if (ratio < 0.25) cls = 'deadline-red';
  else if (ratio < 0.5) cls = 'deadline-yellow';
  return `<div class="detail-row"><span class="label">${label}</span><span class="value"><span class="deadline-badge ${cls}">${formatDate(deadline)}</span></span></div>`;
}

function impactColor(score) {
  if (score <= 30) return '#66BB6A';
  if (score <= 60) return '#FFB74D';
  if (score <= 80) return '#FF7043';
  return '#EF5350';
}


async function loadDetail() {
  const id = new URLSearchParams(window.location.search).get('id');
  if (!id) { document.getElementById('detailContent').innerHTML = '<p>No grievance ID provided.</p>'; return; }
  try {
    const [g, officers] = await Promise.all([
      api('GET', `/grievances/${id}`),
      api('GET', '/auth/officers').catch(() => [])
    ]);
    officersList = officers || [];
    const officerOptions = officersList.map(o =>
      `<option value="${escapeHtml(o.full_name)}"${o.full_name === g.assigned_officer ? ' selected' : ''}>${escapeHtml(o.full_name)} (${escapeHtml(o.department || 'general')})</option>`
    ).join('');

    // Impact score display
    const impactHtml = g.impact_score != null ? `<div class="detail-row"><span class="label">Impact Score</span><span class="value"><span class="impact-circle" style="background:${impactColor(g.impact_score)}">${g.impact_score}</span> / 100</span></div>` : '';

    // Systemic issue link
    const systemicHtml = g.systemic_issue_id ? `<div class="detail-row"><span class="label">Systemic Issue</span><span class="value"><a href="/systemic-issue-detail?id=${encodeURIComponent(g.systemic_issue_id)}" class="badge badge-escalated">Part of Systemic Issue →</a></span></div>` : '';

    // Scheme match
    let schemeHtml = '';
    if (g.scheme_match) {
      schemeHtml = `<div class="scheme-match-card">
        <strong><span class="icon sm">auto_awesome</span> Matching Government Scheme</strong><br>
        <span style="font-size:1.05rem;font-weight:600;">${escapeHtml(g.scheme_match.scheme_name)}</span>
        <span class="badge badge-dept" style="margin-left:0.5rem;">${Math.round(g.scheme_match.relevance_score * 100)}% match</span><br>
        <span class="text-sm">${g.scheme_match.eligibility_likely ? '<span class="icon sm filled">check_circle</span> Likely eligible' : '<span class="icon sm">help</span> Eligibility uncertain'}: ${escapeHtml(g.scheme_match.eligibility_reasoning || '')}</span>
        <br><a href="/scheme-detail?id=${encodeURIComponent(g.scheme_match.scheme_id)}" class="text-sm">View scheme details →</a>
      </div>`;
    }

    // Sub-tasks (cross-department dependencies)
    let subTasksHtml = '';
    if (g.sub_tasks && g.sub_tasks.length > 0) {
      subTasksHtml = `<h3 class="mt-2"><span class="icon sm">link</span> Cross-Department Tasks</h3>` +
        g.sub_tasks.map(st => `
          <div class="sub-task-card ${st.status === 'resolved' ? 'resolved' : ''}">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong>${escapeHtml(deptLabel(st.department))}</strong>
              ${statusBadge(st.status)}
            </div>
            <p class="text-sm" style="margin:0.3rem 0;">${escapeHtml(st.task)}</p>
            <span class="text-sm text-muted">Assigned: ${escapeHtml(st.assigned_officer || 'Unassigned')}</span>
            ${!isCitizen && st.status !== 'resolved' ? `
              <div style="margin-top:0.5rem;display:flex;gap:0.3rem;">
                <button class="btn btn-success btn-sm subtask-resolve-btn" data-gid="${escapeHtml(g.id)}" data-stid="${escapeHtml(st.id)}"><span class="icon sm">check_circle</span> Resolve</button>
                <button class="btn btn-secondary btn-sm subtask-assign-btn" data-gid="${escapeHtml(g.id)}" data-stid="${escapeHtml(st.id)}">Assign</button>
              </div>` : ''}
          </div>`).join('');
    }


    document.getElementById('detailContent').innerHTML = `
      <h1>#${escapeHtml(g.tracking_number)}</h1>
      <div class="two-col">
        <div>
          <div class="card" style="padding:1.5rem;">
            <h3>${escapeHtml(g.title)}</h3>
            <p style="line-height:1.7;margin-bottom:1rem;">${escapeHtml(g.description)}</p>
            <div class="detail-section">
              <div class="detail-row"><span class="label">Status</span><span class="value">${statusBadge(g.status)}</span></div>
              <div class="detail-row"><span class="label">Department</span><span class="value">${deptBadge(g.department)}</span></div>
              <div class="detail-row"><span class="label">Priority</span><span class="value">${priorityBadge(g.priority)}</span></div>
              ${impactHtml}
              <div class="detail-row"><span class="label">Sentiment</span><span class="value">${escapeHtml(g.sentiment)}</span></div>
              <div class="detail-row"><span class="label">District</span><span class="value">${escapeHtml(g.district || 'N/A')}</span></div>
              <div class="detail-row"><span class="label">Filed</span><span class="value">${formatDate(g.created_at)}</span></div>
              ${deadlineBadge(g.sla_deadline, 'SLA Deadline')}
              ${deadlineBadge(g.estimated_resolution_deadline, 'Est. Resolution')}
              <div class="detail-row"><span class="label">Citizen</span><span class="value">${g.is_anonymous ? 'Anonymous' : escapeHtml((g.citizen_name || '') + ' (' + (g.citizen_email || '') + ')')}</span></div>
              <div class="detail-row"><span class="label">Assigned</span><span class="value">${escapeHtml(g.assigned_officer || 'Unassigned')}</span></div>
              ${systemicHtml}
            </div>

            <!-- Attachments -->
            <div id="attachmentsSection"></div>

            <!-- Community Vouches -->
            <div id="vouchesSection" class="vouch-section"></div>

            ${schemeHtml}


            ${g.ai_resolution ? (() => {
              const tier = g.resolution_tier || 'officer_action';
              let label, extra = '';
              if (isCitizen) {
                if (tier === 'self_resolvable') {
                  label = '<span class="icon sm">smart_toy</span> AI Guidance';
                  return `<div class="resolution-box ai"><div class="resolution-header">${label}</div><div class="resolution-content">${renderMarkdown(g.ai_resolution)}</div></div>`;
                } else { return ''; }
              } else {
                if (tier === 'self_resolvable') {
                  label = 'AI Guidance (awaiting citizen confirmation)';
                } else {
                  label = 'AI Draft for Review';
                  if (g.status !== 'resolved') {
                    extra = '<div style="display:flex;gap:.5rem;margin-top:.75rem;"><button class="btn btn-success btn-sm approve-draft-btn" data-id="' + escapeHtml(g.id) + '"><span class="icon sm">check_circle</span> Approve &amp; Send</button><button class="btn btn-primary btn-sm edit-draft-btn" data-id="' + escapeHtml(g.id) + '"><span class="icon sm">edit</span> Edit &amp; Send</button></div>';
                  }
                }
                return '<div class="resolution-box ai"><div class="resolution-header">' + label + ' (' + Math.round((g.confidence_score||0)*100) + '% confidence)</div><div class="resolution-content">' + renderMarkdown(g.ai_resolution) + '</div>' + extra + '</div>';
              }
            })() : ''}
            ${g.manual_resolution ? `<div class="resolution-box manual"><div class="resolution-header">Officer Resolution</div><div class="resolution-content">${renderMarkdown(g.manual_resolution)}</div></div>` : ''}
            ${subTasksHtml}
            ${g.notes?.length ? '<h3 class="mt-2"><span class="icon sm">description</span> Notes</h3>' + g.notes.map(n => `<div class="note-item"><div class="note-meta">${escapeHtml(n.officer)} · ${escapeHtml(n.note_type)} · ${formatDate(n.created_at)}</div><p>${escapeHtml(n.content)}</p></div>`).join('') : ''}
          </div>
        </div>
        ${isCitizen ? `
        <div>
          <div class="card" style="padding:1.5rem;">
            <h3>Feedback</h3>
            ${g.status === 'resolved' ? '<p style="color:var(--success);font-weight:600;"><span class="icon sm filled">check_circle</span> This grievance has been resolved.</p>' : '<p>Your grievance is being processed.</p>'}
            ${g.ai_resolution && g.resolution_tier === 'self_resolvable' && g.status === 'pending' ? `
              <hr style="border-color:var(--outline-variant, rgba(255,255,255,0.2));margin:1rem 0;">
              <p style="font-weight:600;">Did the AI guidance help?</p>
              <div style="display:flex;gap:0.5rem;margin-top:0.5rem;">
                <button class="btn btn-success btn-sm citizen-confirm-yes" data-tracking="${escapeHtml(g.tracking_number)}"><span class="icon sm">check_circle</span> Yes, resolved</button>
                <button class="btn btn-secondary btn-sm citizen-confirm-no" data-tracking="${escapeHtml(g.tracking_number)}"><span class="icon sm">close</span> No, need help</button>
              </div>` : ''}
          </div>
        </div>` : `
        <div>
          <div class="card" style="padding:1.5rem;">
            <h3>Actions</h3>
            <div class="form-group"><label>Update Status</label>
              <select class="form-control" id="newStatus">
                <option value="pending"${g.status==='pending'?' selected':''}>Pending</option>
                <option value="in_progress"${g.status==='in_progress'?' selected':''}>In Progress</option>
                <option value="resolved"${g.status==='resolved'?' selected':''}>Resolved</option>
                <option value="escalated"${g.status==='escalated'?' selected':''}>Escalated</option>
              </select></div>
            <button class="btn btn-primary btn-block btn-sm mb-2 update-status-btn" data-id="${escapeHtml(g.id)}">Update Status</button>
            <hr style="border-color:var(--outline-variant, rgba(255,255,255,0.2));margin:1rem 0;">
            <div class="form-group"><label>Assign Officer</label>
              <select class="form-control" id="assignName"><option value="">-- Select --</option>${officerOptions}</select></div>
            <button class="btn btn-secondary btn-block btn-sm mb-2 assign-officer-btn" data-id="${escapeHtml(g.id)}">Assign</button>
            <hr style="border-color:var(--outline-variant, rgba(255,255,255,0.2));margin:1rem 0;">
            <h3>Resolve Manually</h3>
            <div class="form-group"><textarea class="form-control" id="resolutionText" placeholder="Enter resolution..." style="min-height:160px;"></textarea></div>
            <div class="form-check mb-1"><input type="checkbox" id="addMemory" checked><label for="addMemory">Add to service memory</label></div>
            <button class="btn btn-success btn-block btn-sm mb-2 resolve-manual-btn" data-id="${escapeHtml(g.id)}">Submit Resolution</button>
            <hr style="border-color:var(--outline-variant, rgba(255,255,255,0.2));margin:1rem 0;">
            <h3>Add Note</h3>
            <div class="form-group"><textarea class="form-control" id="noteText" placeholder="Note content..." style="min-height:60px;"></textarea></div>
            <div class="form-group"><select class="form-control" id="noteType"><option value="internal">Internal</option><option value="citizen_facing">Citizen Facing</option></select></div>
            <button class="btn btn-secondary btn-block btn-sm add-note-btn" data-id="${escapeHtml(g.id)}">Add Note</button>
          </div>
        </div>`}
      </div>`;

    // Load attachments and vouches
    loadAttachments(g.id);
    loadVouches(g.id);

    // Bind action buttons
    const gid = g.id;
    if (isCitizen) {
      document.querySelector('.citizen-confirm-yes')?.addEventListener('click', (e) => citizenConfirm(e.target.dataset.tracking, true));
      document.querySelector('.citizen-confirm-no')?.addEventListener('click', (e) => citizenConfirm(e.target.dataset.tracking, false));
    } else {
      document.querySelector('.update-status-btn')?.addEventListener('click', () => updateStatus(gid));
      document.querySelector('.assign-officer-btn')?.addEventListener('click', () => assignOfficer(gid));
      document.querySelector('.resolve-manual-btn')?.addEventListener('click', () => resolveManual(gid));
      document.querySelector('.add-note-btn')?.addEventListener('click', () => addNote(gid));
      document.querySelector('.approve-draft-btn')?.addEventListener('click', () => approveDraft(gid));
      document.querySelector('.edit-draft-btn')?.addEventListener('click', () => editDraft(gid));
      // Sub-task buttons
      document.querySelectorAll('.subtask-resolve-btn').forEach(btn => {
        btn.addEventListener('click', () => updateSubTask(btn.dataset.gid, btn.dataset.stid, 'resolved'));
      });
      document.querySelectorAll('.subtask-assign-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = prompt('Enter officer name:');
          if (name) assignSubTask(btn.dataset.gid, btn.dataset.stid, name);
        });
      });
    }
  } catch (e) { document.getElementById('detailContent').innerHTML = `<p style="color:var(--error);">Error: ${escapeHtml(e.message)}</p>`; }
}

async function loadAttachments(gid) {
  try {
    const atts = await api('GET', `/grievances/${gid}/attachments`);
    if (!atts || !atts.length) return;
    const section = document.getElementById('attachmentsSection');
    const tk = getToken() ? `?token=${encodeURIComponent(getToken())}` : '';
    section.innerHTML = '<h3 class="mt-2"><span class="icon sm">attach_file</span> Attachments</h3><div class="attachment-grid">' +
      atts.map(a => {
        const url = `/attachments/${a.id}${tk}`;
        if (a.content_type?.startsWith('image/')) {
          return `<div class="attachment-item"><img src="${url}" alt="${escapeHtml(a.filename)}"><div class="text-sm">${escapeHtml(a.filename)}</div></div>`;
        } else if (a.content_type?.startsWith('audio/')) {
          return `<div class="attachment-item"><span class="icon sm">audiotrack</span><audio controls src="${url}" style="width:140px;"></audio><div class="text-sm">${escapeHtml(a.filename)}</div></div>`;
        } else if (a.content_type?.startsWith('video/')) {
          return `<div class="attachment-item"><video controls src="${url}" style="max-width:140px;max-height:100px;"></video><div class="text-sm">${escapeHtml(a.filename)}</div></div>`;
        }
        return `<div class="attachment-item"><a href="${url}" target="_blank"><span class="icon sm">description</span> ${escapeHtml(a.filename)}</a></div>`;
      }).join('') + '</div>';
  } catch {}
}

async function loadVouches(gid) {
  try {
    const res = await fetch(`/public/grievances/${gid}/vouches`);
    if (!res.ok) return;
    const vouches = await res.json();
    const section = document.getElementById('vouchesSection');
    if (!vouches.length) return;
    section.innerHTML = `<h3><span class="icon sm">handshake</span> Community Vouches (${vouches.length})</h3>` +
      vouches.map(v => {
        const name = v.is_anonymous ? 'Anonymous' : escapeHtml(v.user_name || 'Citizen');
        const initials = v.is_anonymous ? '?' : name.split(' ').map(w => w[0]).join('').substring(0, 2);
        const vtk = getToken() ? `?token=${encodeURIComponent(getToken())}` : '';
        const evidenceHtml = (v.evidence_file_ids || []).length
          ? '<div class="vouch-evidence-grid">' + v.evidence_file_ids.map(fid => {
              return `<img src="/attachments/${escapeHtml(fid)}${vtk}" alt="Evidence" onclick="window.open('/attachments/${escapeHtml(fid)}${vtk}','_blank')">`;
            }).join('') + '</div>'
          : '';
        return `<div class="vouch-item">
          <div class="vouch-avatar">${initials}</div>
          <div class="vouch-item-body">
            <span class="vouch-item-name">${name}</span><span class="vouch-item-date">${formatDate(v.created_at)}</span>
            ${v.comment ? `<div class="vouch-item-comment">${escapeHtml(v.comment)}</div>` : '<div class="vouch-item-comment" style="font-style:italic;opacity:0.6;">Vouched without comment</div>'}
            ${evidenceHtml}
          </div>
        </div>`;
      }).join('');
  } catch {}
}

async function citizenConfirm(trackingNumber, helpful) {
  try {
    await api('PUT', '/grievances/confirm-resolution', { tracking_number: trackingNumber, helpful });
    showToast(helpful ? 'Grievance marked as resolved!' : 'Forwarded to an officer.');
    loadDetail();
  } catch (e) { showToast(e.message, 'error'); }
}
async function updateStatus(id) {
  try { await api('PUT', `/grievances/${id}/status?new_status=${document.getElementById('newStatus').value}`); showToast('Status updated'); loadDetail(); } catch (e) { showToast(e.message, 'error'); }
}
async function assignOfficer(id) {
  const name = document.getElementById('assignName').value;
  if (!name) { showToast('Select an officer', 'error'); return; }
  try { await api('PUT', `/grievances/${id}/assign`, { officer_name: name }); showToast('Officer assigned'); loadDetail(); } catch (e) { showToast(e.message, 'error'); }
}
async function resolveManual(id) {
  const text = document.getElementById('resolutionText').value;
  if (!text) return;
  try { await api('PUT', `/grievances/${id}/resolve`, { resolution: text, officer: getUser().full_name, add_to_service_memory: document.getElementById('addMemory').checked }); showToast('Resolved!'); loadDetail(); } catch (e) { showToast(e.message, 'error'); }
}
async function addNote(id) {
  const text = document.getElementById('noteText').value;
  if (!text) return;
  try { await api('POST', `/grievances/${id}/notes`, { content: text, officer: getUser().full_name, note_type: document.getElementById('noteType').value }); showToast('Note added'); loadDetail(); } catch (e) { showToast(e.message, 'error'); }
}
async function approveDraft(id) {
  try { await api('PUT', `/grievances/${id}/approve-draft`, { resolution: null }); showToast('Draft approved'); loadDetail(); } catch (e) { showToast(e.message, 'error'); }
}
function editDraft(id) {
  const aiBox = document.querySelector('.resolution-box.ai .resolution-content');
  if (aiBox) {
    const ta = document.getElementById('resolutionText');
    const temp = document.createElement('div'); temp.innerHTML = aiBox.innerHTML;
    ta.value = temp.textContent || temp.innerText || '';
    ta.style.height = Math.max(260, ta.scrollHeight + 8) + 'px';
    ta.focus(); ta.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}
async function updateSubTask(gid, stid, status) {
  try { await api('PUT', `/grievances/${gid}/sub-tasks/${stid}/status?new_status=${status}`); showToast('Sub-task updated'); loadDetail(); } catch (e) { showToast(e.message, 'error'); }
}
async function assignSubTask(gid, stid, name) {
  try { await api('PUT', `/grievances/${gid}/sub-tasks/${stid}/assign`, { officer_name: name }); showToast('Sub-task assigned'); loadDetail(); } catch (e) { showToast(e.message, 'error'); }
}
</script>
{% endblock %}
