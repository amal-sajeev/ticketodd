{% extends "base.html" %}
{% block title %}Grievance Detail ‚Äî PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content wide">
  <a id="backLink" href="/queue" class="btn btn-secondary btn-sm mb-2">‚Üê Back to Queue</a>
  <div id="detailContent"><div class="spinner"><span></span><span></span><span></span></div></div>
</div>
{% endblock %}
{% block scripts %}
<script>
let officersList = [];
const user = getUser();
const isCitizen = user && user.role === 'citizen';

if (requireAuth()) {
  if (isCitizen) {
    const bl = document.getElementById('backLink');
    bl.href = '/dashboard';
    bl.textContent = '\u2190 Back to Dashboard';
  }
  loadDetail();
}

async function loadDetail() {
  const id = new URLSearchParams(window.location.search).get('id');
  if (!id) { document.getElementById('detailContent').innerHTML = '<p>No grievance ID provided.</p>'; return; }
  try {
    const [g, officers] = await Promise.all([
      api('GET', `/grievances/${id}`),
      api('GET', '/auth/officers').catch(() => [])
    ]);
    officersList = officers || [];
    const officerOptions = officersList.map(o =>
      `<option value="${escapeHtml(o.full_name)}"${o.full_name === g.assigned_officer ? ' selected' : ''}>${escapeHtml(o.full_name)} (${escapeHtml(o.department || 'general')})</option>`
    ).join('');
    const user = getUser();
    document.getElementById('detailContent').innerHTML = `
      <h1>#${escapeHtml(g.tracking_number)}</h1>
      <div class="two-col">
        <div>
          <div class="glass-strong card" style="padding:1.5rem;">
            <h3>${escapeHtml(g.title)}</h3>
            <p style="line-height:1.7;margin-bottom:1rem;">${escapeHtml(g.description)}</p>
            <div class="detail-section">
              <div class="detail-row"><span class="label">Status</span><span class="value">${statusBadge(g.status)}</span></div>
              <div class="detail-row"><span class="label">Department</span><span class="value">${deptBadge(g.department)}</span></div>
              <div class="detail-row"><span class="label">Priority</span><span class="value">${priorityBadge(g.priority)}</span></div>
              <div class="detail-row"><span class="label">Sentiment</span><span class="value">${escapeHtml(g.sentiment)}</span></div>
              <div class="detail-row"><span class="label">District</span><span class="value">${escapeHtml(g.district || 'N/A')}</span></div>
              <div class="detail-row"><span class="label">Language</span><span class="value">${escapeHtml(g.language)}</span></div>
              <div class="detail-row"><span class="label">Filed</span><span class="value">${formatDate(g.created_at)}</span></div>
              <div class="detail-row"><span class="label">SLA Deadline</span><span class="value">${formatDate(g.sla_deadline)}</span></div>
              <div class="detail-row"><span class="label">Citizen</span><span class="value">${g.is_anonymous ? 'Anonymous' : escapeHtml((g.citizen_name || '') + ' (' + (g.citizen_email || '') + ')')}</span></div>
              <div class="detail-row"><span class="label">Assigned</span><span class="value">${escapeHtml(g.assigned_officer || 'Unassigned')}</span></div>
            </div>
            ${g.ai_resolution ? (() => {
              const tier = g.resolution_tier || 'officer_action';
              let label, extra = '';
              if (isCitizen) {
                if (tier === 'self_resolvable') {
                  label = 'ü§ñ AI Guidance';
                  return `<div class="resolution-box ai"><div class="resolution-header">${label}</div><div class="resolution-content">${renderMarkdown(g.ai_resolution)}</div></div>`;
                } else {
                  return '';
                }
              } else {
                if (tier === 'self_resolvable') {
                  label = 'AI Guidance (awaiting citizen confirmation)';
                } else {
                  label = 'AI Draft for Review';
                  if (g.status !== 'resolved') {
                    extra = `<div style="display:flex;gap:.5rem;margin-top:.75rem;">
                      <button class="btn btn-success btn-sm approve-draft-btn" data-id="${escapeHtml(g.id)}">‚úì Approve &amp; Send</button>
                      <button class="btn btn-primary btn-sm edit-draft-btn" data-id="${escapeHtml(g.id)}">‚úé Edit &amp; Send</button>
                    </div>`;
                  }
                }
                return `<div class="resolution-box ai"><div class="resolution-header">${label} (${Math.round((g.confidence_score||0)*100)}% confidence)</div><div class="resolution-content">${renderMarkdown(g.ai_resolution)}</div>${extra}</div>`;
              }
            })() : ''}
            ${g.manual_resolution ? `<div class="resolution-box manual"><div class="resolution-header">Officer Resolution</div><div class="resolution-content">${renderMarkdown(g.manual_resolution)}</div></div>` : ''}
            ${g.notes?.length ? '<h3 class="mt-2">üìù Notes</h3>' + g.notes.map(n => `<div class="note-item"><div class="note-meta">${escapeHtml(n.officer)} ¬∑ ${escapeHtml(n.note_type)} ¬∑ ${formatDate(n.created_at)}</div><p>${escapeHtml(n.content)}</p></div>`).join('') : ''}
          </div>
        </div>
        ${isCitizen ? `
        <div>
          <div class="glass-strong card" style="padding:1.5rem;">
            <h3>Feedback</h3>
            ${g.status === 'resolved' ? '<p style="color:#2E7D32;font-weight:600;">‚úÖ This grievance has been resolved.</p>' : '<p>Your grievance is being processed. You will be notified when there is an update.</p>'}
            ${g.ai_resolution && g.resolution_tier === 'self_resolvable' && g.status === 'pending' ? `
              <hr style="border-color:rgba(255,255,255,0.2);margin:1rem 0;">
              <p style="font-weight:600;">Did the AI guidance help resolve your issue?</p>
              <div style="display:flex;gap:0.5rem;margin-top:0.5rem;">
                <button class="btn btn-success btn-sm citizen-confirm-yes" data-tracking="${escapeHtml(g.tracking_number)}">‚úì Yes, resolved</button>
                <button class="btn btn-secondary btn-sm citizen-confirm-no" data-tracking="${escapeHtml(g.tracking_number)}">‚úó No, need help</button>
              </div>` : ''}
          </div>
        </div>` : `
        <div>
          <div class="glass-strong card" style="padding:1.5rem;">
            <h3>Actions</h3>
            <div class="form-group"><label>Update Status</label>
              <select class="form-control" id="newStatus">
                <option value="pending"${g.status==='pending'?' selected':''}>Pending</option>
                <option value="in_progress"${g.status==='in_progress'?' selected':''}>In Progress</option>
                <option value="resolved"${g.status==='resolved'?' selected':''}>Resolved</option>
                <option value="escalated"${g.status==='escalated'?' selected':''}>Escalated</option>
              </select></div>
            <button class="btn btn-primary btn-block btn-sm mb-2 update-status-btn" data-id="${escapeHtml(g.id)}">Update Status</button>

            <hr style="border-color:rgba(255,255,255,0.2);margin:1rem 0;">
            <div class="form-group"><label>Assign Officer</label>
              <select class="form-control" id="assignName">
                <option value="">-- Select Officer --</option>
                ${officerOptions}
              </select></div>
            <button class="btn btn-secondary btn-block btn-sm mb-2 assign-officer-btn" data-id="${escapeHtml(g.id)}">Assign</button>

            <hr style="border-color:rgba(255,255,255,0.2);margin:1rem 0;">
            <h3>Resolve Manually</h3>
            <div class="form-group"><textarea class="form-control" id="resolutionText" placeholder="Enter resolution..." style="min-height:160px;"></textarea></div>
            <div class="form-check mb-1"><input type="checkbox" id="addMemory" checked><label for="addMemory">Add to service memory</label></div>
            <button class="btn btn-success btn-block btn-sm mb-2 resolve-manual-btn" data-id="${escapeHtml(g.id)}">Submit Resolution</button>

            <hr style="border-color:rgba(255,255,255,0.2);margin:1rem 0;">
            <h3>Add Note</h3>
            <div class="form-group"><textarea class="form-control" id="noteText" placeholder="Note content..." style="min-height:60px;"></textarea></div>
            <div class="form-group"><select class="form-control" id="noteType"><option value="internal">Internal</option><option value="citizen_facing">Citizen Facing</option></select></div>
            <button class="btn btn-secondary btn-block btn-sm add-note-btn" data-id="${escapeHtml(g.id)}">Add Note</button>
          </div>
        </div>`}
      </div>`;
    // Bind action buttons safely
    const gid = g.id;
    if (isCitizen) {
      document.querySelector('.citizen-confirm-yes')?.addEventListener('click', (e) => {
        citizenConfirm(e.target.dataset.tracking, true);
      });
      document.querySelector('.citizen-confirm-no')?.addEventListener('click', (e) => {
        citizenConfirm(e.target.dataset.tracking, false);
      });
    } else {
      document.querySelector('.update-status-btn')?.addEventListener('click', () => updateStatus(gid));
      document.querySelector('.assign-officer-btn')?.addEventListener('click', () => assignOfficer(gid));
      document.querySelector('.resolve-manual-btn')?.addEventListener('click', () => resolveManual(gid));
      document.querySelector('.add-note-btn')?.addEventListener('click', () => addNote(gid));
      document.querySelector('.approve-draft-btn')?.addEventListener('click', () => approveDraft(gid));
      document.querySelector('.edit-draft-btn')?.addEventListener('click', () => editDraft(gid));
    }
  } catch (e) { document.getElementById('detailContent').innerHTML = `<p style="color:#C62828;">Error: ${escapeHtml(e.message)}</p>`; }
}

async function citizenConfirm(trackingNumber, helpful) {
  try {
    await api('PUT', '/grievances/confirm-resolution', { tracking_number: trackingNumber, helpful });
    showToast(helpful ? 'Grievance marked as resolved!' : 'Forwarded to an officer for assistance.');
    loadDetail();
  } catch (e) { showToast(e.message, 'error'); }
}
async function updateStatus(id) {
  try {
    await api('PUT', `/grievances/${id}/status?new_status=${document.getElementById('newStatus').value}`);
    showToast('Status updated'); loadDetail();
  } catch (e) { showToast(e.message, 'error'); }
}
async function assignOfficer(id) {
  const name = document.getElementById('assignName').value;
  if (!name) { showToast('Select an officer first', 'error'); return; }
  try {
    await api('PUT', `/grievances/${id}/assign`, { officer_name: name });
    showToast('Officer assigned'); loadDetail();
  } catch (e) { showToast(e.message, 'error'); }
}
async function resolveManual(id) {
  const text = document.getElementById('resolutionText').value;
  if (!text) return;
  try {
    await api('PUT', `/grievances/${id}/resolve`, {
      resolution: text, officer: getUser().full_name,
      add_to_service_memory: document.getElementById('addMemory').checked });
    showToast('Grievance resolved!'); loadDetail();
  } catch (e) { showToast(e.message, 'error'); }
}
async function addNote(id) {
  const text = document.getElementById('noteText').value;
  if (!text) return;
  try {
    await api('POST', `/grievances/${id}/notes`, {
      content: text, officer: getUser().full_name,
      note_type: document.getElementById('noteType').value });
    showToast('Note added'); loadDetail();
  } catch (e) { showToast(e.message, 'error'); }
}
async function approveDraft(id) {
  try {
    await api('PUT', `/grievances/${id}/approve-draft`, { resolution: null });
    showToast('Draft approved and sent to citizen'); loadDetail();
  } catch (e) { showToast(e.message, 'error'); }
}
function editDraft(id) {
  // Pre-fill the manual resolution textarea with the AI draft so the officer can edit
  const aiBox = document.querySelector('.resolution-box.ai .resolution-content');
  if (aiBox) {
    const ta = document.getElementById('resolutionText');
    // Strip HTML to get plain text (the AI draft is markdown rendered)
    const temp = document.createElement('div');
    temp.innerHTML = aiBox.innerHTML;
    ta.value = temp.textContent || temp.innerText || '';
    // Auto-resize to fit content (minimum 260px)
    ta.style.height = 'auto';
    ta.style.height = Math.max(260, ta.scrollHeight + 8) + 'px';
    ta.focus();
    ta.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}
</script>
{% endblock %}
