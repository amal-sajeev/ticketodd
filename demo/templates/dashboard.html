{% extends "base.html" %}
{% block title %}Dashboard — PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content">
  <h1 id="greeting">My Dashboard</h1>
  <p class="subtitle">Your grievance overview</p>
  <div class="card-grid-4 mb-3" id="metrics"></div>

  <h2>Recent Grievances</h2>
  <div id="grievanceList"></div>
</div>
{% endblock %}
{% block scripts %}
<style>
/* date-group-header and impact-badge styles are now in the main stylesheet */
</style>
<script>
if (!requireAuth()) {}
else {
  const user = getUser();
  document.getElementById('greeting').textContent = `Welcome, ${user.full_name}`;
  loadDashboard();
}

function impactColor(s) { return s<=30?'#66BB6A':s<=60?'#FFB74D':s<=80?'#FF7043':'#EF5350'; }

const DASH_PAGE_SIZE = 30;
let dashOffset = 0;
let dashAllGrievances = [];

async function loadDashboard(append = false) {
  if (!append) showLoading('metrics');
  try {
    const grievances = await api('GET', `/grievances?limit=${DASH_PAGE_SIZE}&skip=${append ? dashOffset : 0}&group_by_date=true`);
    const total = grievances.length;
    const resolved = grievances.filter(g => g.status === 'resolved').length;
    const pending = grievances.filter(g => ['pending','escalated'].includes(g.status)).length;
    const inProgress = grievances.filter(g => g.status === 'in_progress').length;

    document.getElementById('metrics').innerHTML = `
      <div class="metric-card card-animate"><div class="metric-icon blue"><span class="icon">assignment</span></div><div class="metric-value">${total}</div><div class="metric-label">Total Filed</div></div>
      <div class="metric-card card-animate"><div class="metric-icon green"><span class="icon">check_circle</span></div><div class="metric-value">${resolved}</div><div class="metric-label">Resolved</div></div>
      <div class="metric-card card-animate"><div class="metric-icon amber"><span class="icon">schedule</span></div><div class="metric-value">${pending}</div><div class="metric-label">Pending</div></div>
      <div class="metric-card card-animate"><div class="metric-icon blue"><span class="icon">sync</span></div><div class="metric-value">${inProgress}</div><div class="metric-label">In Progress</div></div>`;

    const list = document.getElementById('grievanceList');
    if (!grievances.length) {
      list.innerHTML = '<div class="card" style="text-align:center;padding:2rem;"><p>No grievances filed yet.</p><a href="/file-grievance" class="btn btn-primary mt-2">File Your First Grievance</a></div>';
      return;
    }

    // Group by date
    const groups = {};
    grievances.forEach(g => {
      const dateKey = new Date(g.created_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
      if (!groups[dateKey]) groups[dateKey] = [];
      groups[dateKey].push(g);
    });

    let html = '';
    for (const [date, items] of Object.entries(groups)) {
      html += `<div class="date-group-header"><span class="icon sm">calendar_today</span><h3>${date}</h3><span class="count">${items.length} grievance${items.length !== 1 ? 's' : ''}</span></div>`;
      html += items.map(g => {
        let selfResolvePrompt = '';
        if (g.resolution_tier === 'self_resolvable' && g.status === 'pending' && g.ai_resolution) {
          selfResolvePrompt = `
            <div style="margin-top:0.75rem;padding:0.75rem 1rem;background:var(--success-container);border-radius:var(--radius-sm);border:1px solid rgba(30,142,62,0.2);">
              <p style="font-size:0.85rem;font-weight:600;margin-bottom:0.4rem;"><span class="icon sm" style="color:var(--success);">auto_awesome</span> AI guidance available — did it help?</p>
              <div style="display:flex;gap:0.5rem;">
                <button class="btn btn-success btn-sm confirm-yes-btn" style="font-size:.78rem;" data-tracking="${escapeHtml(g.tracking_number)}">Yes, resolved</button>
                <button class="btn btn-secondary btn-sm confirm-no-btn" style="font-size:.78rem;" data-tracking="${escapeHtml(g.tracking_number)}">No, need help</button>
                <a href="/grievance-detail?id=${encodeURIComponent(g.id)}" class="btn btn-primary btn-sm view-guidance-link" style="font-size:.78rem;">View</a>
              </div>
            </div>`;
        }
        const impactBadge = g.impact_score != null ? `<span class="impact-badge" style="background:${impactColor(g.impact_score)}">${g.impact_score}</span>` : '';
        return `
          <div class="grievance-card card-animate status-${g.status}" data-gid="${escapeHtml(g.id)}" style="cursor:pointer;">
            <h4>#${escapeHtml(g.tracking_number)} — ${escapeHtml(g.title)}</h4>
            <div class="badges">
              ${statusBadge(g.status)} ${deptBadge(g.department)} ${priorityBadge(g.priority)} ${impactBadge}
            </div>${selfResolvePrompt}
          </div>`;
      }).join('');
    }
    const dashHasMore = grievances.length >= DASH_PAGE_SIZE;
    const oldBtn = document.getElementById('dashLoadMore');
    if (oldBtn) oldBtn.remove();

    if (append) {
      list.insertAdjacentHTML('beforeend', html);
      dashOffset += grievances.length;
    } else {
      list.innerHTML = html;
      dashOffset = grievances.length;
    }

    if (dashHasMore) {
      list.insertAdjacentHTML('beforeend',
        '<div id="dashLoadMore" class="load-more-wrap"><button class="btn btn-secondary" onclick="loadDashboard(true)"><span class="icon sm">expand_more</span> Load More</button></div>');
    }

    document.querySelectorAll('.confirm-yes-btn').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); confirmRes(btn.dataset.tracking, true); });
    });
    document.querySelectorAll('.confirm-no-btn').forEach(btn => {
      btn.addEventListener('click', (e) => { e.stopPropagation(); confirmRes(btn.dataset.tracking, false); });
    });
    document.querySelectorAll('.view-guidance-link').forEach(link => link.addEventListener('click', e => e.stopPropagation()));
    document.querySelectorAll('.grievance-card[data-gid]').forEach(card => {
      card.addEventListener('click', () => { window.location.href = `/grievance-detail?id=${encodeURIComponent(card.dataset.gid)}`; });
    });
  } catch (e) { showToast(e.message, 'error'); }
}
async function confirmRes(trackingNumber, helpful) {
  try { await api('PUT', '/grievances/confirm-resolution', { tracking_number: trackingNumber, helpful }); showToast(helpful ? 'Resolved!' : 'Forwarded to officer.'); loadDashboard(); } catch (e) { showToast(e.message, 'error'); }
}
</script>
{% endblock %}
