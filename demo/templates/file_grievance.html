{% extends "base.html" %}
{% block title %}File Grievance — PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content" style="max-width:800px;">
  <h1><span class="icon filled">description</span> File a Grievance</h1>
  <p class="subtitle">Describe your issue and we'll process it with AI assistance</p>

  <!-- Spam Block Banner -->
  <div id="spamBanner" class="hidden" style="background:var(--error-container);border:1px solid rgba(198,40,40,0.4);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem;">
    <h3 style="color:var(--error);margin:0 0 0.5rem;"><span class="icon filled">warning</span> Account Restricted</h3>
    <p id="spamReason" style="margin:0 0 1rem;">Your account has been flagged. Please upload a government-issued photo ID to verify your identity.</p>
    <div id="photoIdUploadArea">
      <div class="file-input-wrap" style="margin-bottom:0.5rem;">
        <span class="file-input-btn"><span class="icon">upload_file</span> Choose File</span>
        <span class="file-input-label" id="photoIdLabel">No file chosen</span>
        <input type="file" id="photoIdFile" accept="image/jpeg,image/png,image/webp">
      </div>
      <button class="btn btn-primary btn-sm" onclick="uploadPhotoId()">Upload Photo ID</button>
      <p id="photoIdStatus" class="text-sm text-muted mt-1"></p>
    </div>
  </div>


  <div id="formArea">
    <form class="card" id="grievanceForm" onsubmit="return submitGrievance(event)" style="padding:2rem;">
      <div class="form-group"><label>Grievance Title *</label><input type="text" class="form-control" id="title" placeholder="Brief summary of your issue" required maxlength="200"></div>
      <div class="form-group"><label>Detailed Description *</label><textarea class="form-control" id="description" placeholder="Describe your grievance in detail..." required maxlength="5000" style="min-height:140px;"></textarea></div>
      <div class="form-row">
        <div class="form-group"><label>Preferred Language</label>
          <select class="form-control" id="language">
            <option value="english">English</option><option value="odia">Odia (ଓଡ଼ିଆ)</option><option value="hindi">Hindi (हिन्दी)</option>
          </select></div>
        <div class="form-group"><label>District</label><select class="form-control" id="district"></select></div>
      </div>

      <!-- Attachments -->
      <div class="form-group">
        <label><span class="icon sm">attach_file</span> Attachments (photos, audio, video — max 5 files, 50MB each)</label>
        <div class="file-input-wrap">
          <span class="file-input-btn"><span class="icon">upload_file</span> Choose Files</span>
          <span class="file-input-label" id="fileInputLabel">No file chosen</span>
          <input type="file" id="fileInput" multiple accept="image/*,audio/*,video/*">
        </div>
        <div id="filePreview" style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem;"></div>
      </div>

      <div class="form-check mb-2"><input type="checkbox" id="anonymous"><label for="anonymous">File anonymously</label></div>

      <!-- Public checkbox -->
      <div class="form-check mb-2" id="publicCheckGroup"><input type="checkbox" id="isPublic"><label for="isPublic">Make this grievance public (visible on community feed for other citizens to vouch)</label></div>


      <div class="form-row">
        <div class="form-group"><label>Your Name</label><input type="text" class="form-control" id="citizenName"></div>
        <div class="form-group"><label>Email</label><input type="email" class="form-control" id="citizenEmail"></div>
      </div>

      <!-- Location with auto-detection -->
      <div class="card" style="padding:1rem;border-radius:12px;margin-bottom:1rem;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;">
          <label style="margin:0;font-weight:600;"><span class="icon sm">location_on</span> Location</label>
          <span id="locationStatus" class="text-sm" style="color:#888;">Detecting...</span>
        </div>
        <div class="form-row">
          <div class="form-group" style="margin-bottom:0;"><label class="text-sm">Latitude</label><input type="number" class="form-control" id="lat" step="any"></div>
          <div class="form-group" style="margin-bottom:0;"><label class="text-sm">Longitude</label><input type="number" class="form-control" id="lon" step="any"></div>
        </div>
      </div>


      <button type="submit" class="btn btn-primary btn-block" id="submitBtn"><span class="icon sm">send</span> Submit Grievance</button>
    </form>
  </div>
  <div id="resultArea" class="hidden"></div>
</div>
{% endblock %}
{% block scripts %}
<script>
let isBlocked = false;


if (requireAuth()) {
  const u = getUser();
  document.getElementById('district').innerHTML = districtOptions();
  document.getElementById('citizenName').value = u?.full_name || '';
  document.getElementById('citizenEmail').value = u?.email || '';
  checkSpamStatus();
  detectLocation();
  setupFilePreview();
  setupAnonToggle();
}

// Toggle public checkbox visibility when anonymous is checked
function setupAnonToggle() {
  document.getElementById('anonymous').addEventListener('change', function() {
    document.getElementById('publicCheckGroup').style.display = this.checked ? 'none' : '';
    if (this.checked) document.getElementById('isPublic').checked = false;
  });
}

const MAX_FILES = 5;
const MAX_FILE_SIZE_MB = 50;

function validateFiles(files, maxCount, maxSizeMB) {
  if (files.length > maxCount) {
    showToast(`Too many files. Maximum ${maxCount} allowed.`, 'error');
    return false;
  }
  for (const f of files) {
    if (f.size > maxSizeMB * 1024 * 1024) {
      showToast(`"${f.name}" exceeds ${maxSizeMB} MB limit.`, 'error');
      return false;
    }
  }
  return true;
}

function setupFilePreview() {
  document.getElementById('fileInput').addEventListener('change', function() {
    const preview = document.getElementById('filePreview');
    preview.innerHTML = '';
    const label = document.getElementById('fileInputLabel');
    if (this.files.length) {
      if (!validateFiles(this.files, MAX_FILES, MAX_FILE_SIZE_MB)) {
        this.value = '';
        label.textContent = 'No file chosen';
        return;
      }
      label.textContent = this.files.length === 1 ? this.files[0].name : `${this.files.length} files selected`;
    } else {
      label.textContent = 'No file chosen';
    }
    Array.from(this.files).forEach(f => {
      const tag = document.createElement('div');
      tag.style.cssText = 'background:var(--primary-container-low);padding:0.3rem 0.6rem;border-radius:8px;font-size:0.82rem;display:flex;align-items:center;gap:0.3rem;';
      const iconName = f.type.startsWith('image/') ? 'image' : f.type.startsWith('audio/') ? 'audiotrack' : 'videocam';
      tag.innerHTML = `<span class="icon sm">${iconName}</span> ${f.name} (${(f.size/1024/1024).toFixed(1)}MB)`;
      preview.appendChild(tag);
    });
  });

  document.getElementById('photoIdFile').addEventListener('change', function() {
    const label = document.getElementById('photoIdLabel');
    label.textContent = this.files.length ? this.files[0].name : 'No file chosen';
  });
}

// Auto-detect location
async function detectLocation() {
  const statusEl = document.getElementById('locationStatus');
  // Try browser geolocation first
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
        document.getElementById('lon').value = pos.coords.longitude.toFixed(6);
        statusEl.innerHTML = '<span class="icon sm filled">check_circle</span> GPS location detected';
        statusEl.style.color = 'var(--success)';
      },
      async () => { await fallbackIPLocation(statusEl); },
      { timeout: 5000 }
    );
  } else {
    await fallbackIPLocation(statusEl);
  }
}

async function fallbackIPLocation(statusEl) {
  try {
    const data = await api('GET', '/location/from-ip');
    if (data.latitude && data.longitude) {
      document.getElementById('lat').value = data.latitude.toFixed(6);
      document.getElementById('lon').value = data.longitude.toFixed(6);
      statusEl.innerHTML = `<span class="icon sm">sensors</span> Approximate: ${data.city || ''}, ${data.region || ''}`;
      statusEl.style.color = 'var(--warning, #F57F17)';
    }
  } catch {
    statusEl.innerHTML = '<span class="icon sm">error</span> Location not available';
    statusEl.style.color = 'var(--on-surface-variant, #888)';
  }
}

// Spam status check
async function checkSpamStatus() {
  try {
    const status = await api('GET', '/auth/spam-status');
    if (status.is_blocked) {
      isBlocked = true;
      document.getElementById('spamBanner').classList.remove('hidden');
      document.getElementById('formArea').style.opacity = '0.4';
      document.getElementById('formArea').style.pointerEvents = 'none';
      if (status.photo_id_status === 'pending_review') {
        document.getElementById('photoIdStatus').innerHTML = '<span class="icon sm">schedule</span> Your photo ID is pending admin review.';
        document.getElementById('photoIdUploadArea').querySelector('button').disabled = true;
      } else if (status.photo_id_status === 'rejected') {
        document.getElementById('photoIdStatus').innerHTML = '<span class="icon sm">error</span> Photo ID rejected. Please upload a clearer image.';
      }
    }
  } catch {}
}

async function uploadPhotoId() {
  const fileInput = document.getElementById('photoIdFile');
  if (!fileInput.files.length) { showToast('Select a photo first', 'error'); return; }
  const fd = new FormData();
  fd.append('file', fileInput.files[0]);
  try {
    const res = await fetch('/auth/upload-photo-id', {
      method: 'POST', body: fd,
      headers: { 'Authorization': `Bearer ${getToken()}` }
    });
    if (!res.ok) throw new Error((await res.json()).detail || 'Upload failed');
    showToast('Photo ID uploaded for review');
    document.getElementById('photoIdStatus').innerHTML = '<span class="icon sm">schedule</span> Pending admin review.';
  } catch (e) { showToast(e.message, 'error'); }
}

async function submitGrievance(e) {
  e.preventDefault();
  if (isBlocked) { showToast('Account restricted. Upload photo ID first.', 'error'); return; }
  const btn = document.getElementById('submitBtn');
  btn.textContent = 'Processing...'; btn.disabled = true;

  const fd = new FormData();
  fd.append('title', document.getElementById('title').value);
  fd.append('description', document.getElementById('description').value);
  fd.append('language', document.getElementById('language').value);
  fd.append('district', document.getElementById('district').value || '');
  fd.append('is_anonymous', document.getElementById('anonymous').checked);
  fd.append('is_public', document.getElementById('isPublic').checked);
  fd.append('citizen_name', document.getElementById('citizenName').value || '');
  fd.append('citizen_email', document.getElementById('citizenEmail').value || '');
  const lat = document.getElementById('lat').value;
  const lon = document.getElementById('lon').value;
  if (lat) fd.append('latitude', lat);
  if (lon) fd.append('longitude', lon);
  // Attach files (with validation)
  const fileInput = document.getElementById('fileInput');
  if (fileInput.files.length) {
    if (!validateFiles(fileInput.files, MAX_FILES, MAX_FILE_SIZE_MB)) {
      btn.textContent = 'Submit Grievance'; btn.disabled = false;
      return;
    }
    Array.from(fileInput.files).forEach(f => fd.append('files', f));
  }

  try {
    const res = await fetch('/grievances', {
      method: 'POST', body: fd,
      headers: { 'Authorization': `Bearer ${getToken()}` }
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || `Request failed (${res.status})`);
    }
    const result = await res.json();
    document.getElementById('formArea').classList.add('hidden');
    document.getElementById('resultArea').classList.remove('hidden');
    let schemeHtml = '';
    if (result.scheme_match) {
      schemeHtml = `<div class="card" style="padding:1rem;border-radius:12px;margin-top:1rem;background:var(--success-container);border:1px solid rgba(76,175,80,0.3);">
        <strong><span class="icon sm">auto_awesome</span> Matching Scheme:</strong> ${escapeHtml(result.scheme_match.scheme_name)}<br>
        <span class="text-sm">${escapeHtml(result.scheme_match.eligibility_reasoning || '')}</span>
        <br><a href="/scheme-detail?id=${encodeURIComponent(result.scheme_match.scheme_id)}" class="text-sm">Learn more →</a>
      </div>`;
    }
    let impactHtml = result.impact_score != null ? `<span class="badge" style="background:${impactColor(result.impact_score)};color:#fff;font-size:0.85rem;">Impact: ${result.impact_score}/100</span>` : '';
    document.getElementById('resultArea').innerHTML = `
      <div class="result-card card">
        <div style="font-size:3rem;margin-bottom:0.5rem;"><span class="icon filled" style="font-size:3rem;">check_circle</span></div>
        <h2>Grievance Submitted Successfully</h2>
        <div class="tracking-number">${escapeHtml(result.tracking_number)}</div>
        <div class="mb-2">${statusBadge(result.status)} ${deptBadge(result.department)} ${priorityBadge(result.priority)} ${impactHtml}</div>
        ${result.ai_resolution && result.resolution_tier === 'self_resolvable' ? `<div class="resolution-box ai mt-2" style="text-align:left;"><div class="resolution-header"><span class="icon sm">smart_toy</span> AI Guidance</div><div class="resolution-content">${renderMarkdown(result.ai_resolution)}</div></div>` : ''}
        ${schemeHtml}
        <div class="mt-3"><a href="/dashboard" class="btn btn-primary">Back to Dashboard</a> <a href="/file-grievance" class="btn btn-secondary" onclick="location.reload()">File Another</a></div>
      </div>`;
  } catch (err) {
    showToast(err.message || 'Failed to submit', 'error');
    btn.innerHTML = '<span class="icon sm">send</span> Submit Grievance'; btn.disabled = false;
  }
}

function impactColor(score) {
  if (score <= 30) return '#66BB6A';
  if (score <= 60) return '#FFB74D';
  if (score <= 80) return '#FF7043';
  return '#EF5350';
}
</script>
{% endblock %}
