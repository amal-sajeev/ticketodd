{% extends "base.html" %}
{% block title %}File Grievance ‚Äî PR&DW Portal{% endblock %}
{% block content %}
<div class="main-content" style="max-width:800px;">
  <h1>üìù File a Grievance</h1>
  <p class="subtitle">Describe your issue and we'll process it with AI assistance</p>

  <div id="formArea">
    <form class="glass-strong card" id="grievanceForm" onsubmit="return submitGrievance(event)" style="padding:2rem;">
      <div class="form-group"><label>Grievance Title *</label><input type="text" class="form-control" id="title" placeholder="Brief summary of your issue" required maxlength="200"></div>
      <div class="form-group"><label>Detailed Description *</label><textarea class="form-control" id="description" placeholder="Describe your grievance in detail..." required maxlength="5000" style="min-height:140px;"></textarea></div>
      <div class="form-row">
        <div class="form-group"><label>Preferred Language</label>
          <select class="form-control" id="language">
            <option value="english">English</option><option value="odia">Odia (‡¨ì‡¨°‡¨º‡¨ø‡¨Ü)</option><option value="hindi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
          </select></div>
        <div class="form-group"><label>District</label><select class="form-control" id="district"></select></div>
      </div>
      <div class="form-check mb-2"><input type="checkbox" id="anonymous"><label for="anonymous">File anonymously</label></div>
      <div class="form-row">
        <div class="form-group"><label>Your Name</label><input type="text" class="form-control" id="citizenName"></div>
        <div class="form-group"><label>Email</label><input type="email" class="form-control" id="citizenEmail"></div>
      </div>
      <details class="mb-2"><summary class="text-sm text-muted" style="cursor:pointer;">üìç Location (Optional)</summary>
        <div class="form-row mt-1">
          <div class="form-group"><label>Latitude</label><input type="number" class="form-control" id="lat" step="any"></div>
          <div class="form-group"><label>Longitude</label><input type="number" class="form-control" id="lon" step="any"></div>
        </div>
      </details>
      <button type="submit" class="btn btn-primary btn-block" id="submitBtn">üöÄ Submit Grievance</button>
    </form>
  </div>
  <div id="resultArea" class="hidden"></div>
</div>
{% endblock %}
{% block scripts %}
<script>
if (requireAuth()) {
  const u = getUser();
  document.getElementById('district').innerHTML = districtOptions();
  document.getElementById('citizenName').value = u?.full_name || '';
  document.getElementById('citizenEmail').value = u?.email || '';
}
async function submitGrievance(e) {
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  btn.textContent = 'Processing...'; btn.disabled = true;
  const body = {
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    language: document.getElementById('language').value,
    district: document.getElementById('district').value || null,
    is_anonymous: document.getElementById('anonymous').checked,
    citizen_name: document.getElementById('citizenName').value || null,
    citizen_email: document.getElementById('citizenEmail').value || null,
  };
  const lat = parseFloat(document.getElementById('lat').value);
  const lon = parseFloat(document.getElementById('lon').value);
  if (lat && lon) body.location = { latitude: lat, longitude: lon };
  try {
    const result = await api('POST', '/grievances', body);
    document.getElementById('formArea').classList.add('hidden');
    document.getElementById('resultArea').classList.remove('hidden');
    document.getElementById('resultArea').innerHTML = `
      <div class="result-card glass-strong">
        <div style="font-size:3rem;margin-bottom:0.5rem;">‚úÖ</div>
        <h2>Grievance Submitted Successfully</h2>
        <div class="tracking-number">${escapeHtml(result.tracking_number)}</div>
        <div class="mb-2">${statusBadge(result.status)} ${deptBadge(result.department)} ${priorityBadge(result.priority)}</div>
        ${result.ai_resolution ? `<div class="resolution-box ai mt-2" style="text-align:left;"><div class="resolution-header">ü§ñ AI Resolution</div><p>${escapeHtml(result.ai_resolution)}</p></div>` : ''}
        <div class="mt-3"><a href="/dashboard" class="btn btn-primary">Back to Dashboard</a> <a href="/file-grievance" class="btn btn-secondary" onclick="location.reload()">File Another</a></div>
      </div>`;
  } catch (err) {
    showToast(err.message || 'Failed to submit', 'error');
    btn.textContent = 'üöÄ Submit Grievance'; btn.disabled = false;
  }
}
</script>
{% endblock %}
