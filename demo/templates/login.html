{% extends "base.html" %}

{% block title %}Login â€” PR&DW Grievance Portal{% endblock %}

{% block head %}
<!-- Allow camera access in this page -->
<meta http-equiv="Permissions-Policy" content="camera=*">
{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/css/auth-v2.css">

<div class="auth-page-container">
  <div class="auth-split-layout">
    <!-- Left Panel: Branding -->
    <div class="auth-left-panel">
      <div class="auth-brand">
        <div class="auth-logo">
          <img src="/static/image.jpg" alt="Government of Odisha" class="auth-logo-img">
        </div>
        <h2>Government of Odisha</h2>
        <p>Panchayati Raj & Drinking Water Department</p>
      </div>

      <div class="auth-features">
        <ul class="auth-feature-list">
          <li class="auth-feature-item">
            <span class="icon">security</span>
            <span>Secure Government Portal</span>
          </li>
          <li class="auth-feature-item">
            <span class="icon">verified_user</span>
            <span>24/7 Grievance Redressal</span>
          </li>
          <li class="auth-feature-item">
            <span class="icon">face</span>
            <span>Biometric Face Authentication</span>
          </li>
        </ul>
        <div class="auth-footer-link">
          Â© 2026 Government of Odisha
        </div>
      </div>
    </div>

    <!-- Right Panel: Login Form -->
    <div class="auth-right-panel">
      <div class="auth-header">
        <h3>Welcome Back</h3>
        <p>Sign in to access your portal</p>
      </div>

      <!-- Tabs -->
      <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('password')">
          <span class="icon sm">key</span> Password
        </div>
        <div class="nav-tab" onclick="switchTab('face')">
          <span class="icon sm">face</span> Face Login
        </div>
      </div>

      <!-- Face Login Section -->
      <div id="faceSection" style="display:none;">
        <div class="video-container active" id="cameraContainer">
          <video id="video" autoplay muted playsinline></video>
          <canvas id="canvas"></canvas>
          <div id="faceStatus" class="status-badge">Loading models...</div>
        </div>
        <p class="text-xs text-center text-muted mb-3" id="faceHint">
          Position your face in the frame
        </p>
      </div>

      <!-- Password Form -->
      <form id="loginForm" onsubmit="return handlePasswordLogin(event)">
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="username" placeholder="Enter username / ID">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" class="form-control" id="password" placeholder="Enter your password">
        </div>
        <button type="submit" class="btn btn-primary btn-block" id="loginBtn">Sign In to Portal</button>
      </form>

      <div id="loginError" class="text-sm text-center"
        style="color:#D32F2F;margin-top:1rem;display:none;background:#ffebee;padding:0.5rem;border-radius:4px;"></div>

      <div style="margin-top:1.5rem;text-align:center;font-size:0.9rem;">
        <span style="color:#74777f;">New User?</span> <a href="/register"
          style="color:#0f4c81;font-weight:600;text-decoration:none;">Register Here</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load face-api.js from CDN (Matching the working reference version) -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
  let stream = null;
  let isFaceMode = false;
  let modelsLoaded = false;
  let isScanning = false;

  function switchTab(mode) {
    const tabs = document.querySelectorAll('.nav-tab');
    const form = document.getElementById('loginForm');
    const faceSec = document.getElementById('faceSection');
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';

    if (mode === 'password') {
      tabs[0].classList.add('active');
      tabs[1].classList.remove('active');
      form.style.display = 'block';
      faceSec.style.display = 'none';
      stopCamera();
      isFaceMode = false;
    } else {
      tabs[0].classList.remove('active');
      tabs[1].classList.add('active');
      form.style.display = 'none';
      faceSec.style.display = 'block';
      isFaceMode = true;
      startFaceLogin();
    }
  }

  async function handlePasswordLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const errEl = document.getElementById('loginError');

    if (!document.getElementById('username').value || !document.getElementById('password').value) {
      showError('Please enter username and password');
      return false;
    }

    errEl.style.display = 'none';
    btn.textContent = 'Signing in...'; btn.disabled = true;

    try {
      const data = await api('POST', '/auth/login', {
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
      });
      handleSuccess(data);
    } catch (err) {
      showError(err.message || 'Invalid credentials');
      btn.textContent = 'Sign In'; btn.disabled = false;
    }
    return false;
  }

  // Face Login Logic
  async function startFaceLogin() {
    const statusEl = document.getElementById('faceStatus');

    // Check if running on secure context
    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      showError("Camera requires HTTPS. Please access via https:// or use localhost.");
      return;
    }

    // Check permissions policy
    if (document.featurePolicy && !document.featurePolicy.allowsFeature('camera')) {
      console.error("âŒ Camera blocked by permissions policy");
      showError("Camera is blocked by page security policy. Please check your browser settings or access via localhost.");
      return;
    }

    if (!modelsLoaded) {
      statusEl.textContent = "Loading AI models...";
      try {
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        modelsLoaded = true;
        console.log("âœ… Face detection models loaded");
      } catch (err) {
        console.error("âŒ Model loading error:", err);
        showError("Failed to load face recognition models");
        return;
      }
    }

    statusEl.textContent = "Starting camera...";
    console.log("ðŸ“· Requesting camera access...");
    console.log("Protocol:", location.protocol, "Hostname:", location.hostname);

    try {
      // Check if camera API is available
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('Camera not supported in this browser');
      }

      const video = document.getElementById('video');

      // Request camera permission with better error handling
      try {
        console.log("Attempting camera access with ideal constraints...");
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
          }
        });
        console.log("âœ… Camera access granted!");
      } catch (err) {
        // Fallback to simpler constraints
        console.warn("âš ï¸ Ideal constraints failed, trying fallback...");
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user' }
        });
        console.log("âœ… Camera access granted (fallback)!");
      }

      video.srcObject = stream;

      video.addEventListener('play', () => {
        const canvas = document.getElementById('canvas');
        const displaySize = { width: video.clientWidth, height: video.clientHeight };
        faceapi.matchDimensions(canvas, displaySize);

        statusEl.textContent = "Detecting face...";
        isScanning = true;

        const interval = setInterval(async () => {
          if (!isScanning || !isFaceMode) {
            clearInterval(interval);
            return;
          }

          const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();

          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          if (detections) {
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            faceapi.draw.drawDetections(canvas, resizedDetections);
            statusEl.textContent = "Verifying...";

            // Found a face, try to login
            isScanning = false; // Stop scanning while verifying
            attemptFaceLogin(detections.descriptor);
          } else {
            statusEl.textContent = "Looking for face...";
          }
        }, 500); // Scan every 500ms
      });
    } catch (err) {
      console.error("Camera error:", err);
      stopCamera();

      // More specific error messages
      if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
        showError("Camera permission denied. Please:\n1. Click the camera icon in your browser's address bar\n2. Allow camera access\n3. Try Face Login again");
      } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
        showError("No camera found. Please connect a camera and try again.");
      } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
        showError("Camera is in use by another application. Please close other apps and try again.");
      } else if (err.name === 'OverconstrainedError') {
        showError("Camera doesn't support the required settings. Try a different camera.");
      } else if (err.name === 'SecurityError') {
        showError("Camera access blocked due to security settings. Please use HTTPS.");
      } else {
        showError("Camera error: " + (err.message || 'Unable to access camera. Please check your browser settings.'));
      }
    }
  }

  async function attemptFaceLogin(descriptor) {
    try {
      const data = await api('POST', '/auth/login', {
        face_descriptor: Array.from(descriptor)
      });
      document.getElementById('faceStatus').textContent = "Success!";
      document.getElementById('faceStatus').style.background = "green";
      handleSuccess(data);
    } catch (err) {
      // If auth failed, resume scanning after a delay
      document.getElementById('faceStatus').textContent = "Not recognized";
      document.getElementById('faceStatus').style.background = "#C62828";
      setTimeout(() => {
        isScanning = true; // Resume scanning
        document.getElementById('faceStatus').style.background = "rgba(0,0,0,0.7)";
        document.getElementById('faceStatus').textContent = "Detecting face...";
      }, 2000);
    }
  }

  function stopCamera() {
    isScanning = false;
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    // Also clear video srcObject
    const video = document.getElementById('video');
    if (video) {
      video.srcObject = null;
    }
  }

  function handleSuccess(data) {
    setAuth(data.access_token, data.user);
    window.location.href = data.user.role === 'citizen' ? '/dashboard' : '/officer-dashboard';
  }

  function showError(msg) {
    const errEl = document.getElementById('loginError');
    errEl.textContent = msg;
    errEl.style.display = 'block';
  }

  // If already logged in, redirect
  if (isLoggedIn()) {
    const u = getUser();
    window.location.href = u?.role === 'citizen' ? '/dashboard' : '/officer-dashboard';
  }
</script>
{% endblock %}